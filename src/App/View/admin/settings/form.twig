{% extends 'admin/layout.twig' %}

{% import 'admin/partials/components.twig' as ui %}

{% set active_section = active_section|default('main') %}
{% set current_menu = 'settings:' ~ active_section %}
{% block title %}Nastavení | Administrace{% endblock %}

{% block body %}
    <h1 class="h4 mb-3">Nastavení</h1>

    <div class="row">
        <div class="col-12">
            <form method="post" action="/admin/settings/{{ active_section }}" class="card shadow-sm" id="settingsForm" enctype="multipart/form-data">
                <div class="card-body p-4">
                    {% if active_section == 'main' %}
                        <h2 class="h5 mb-3">Základní nastavení</h2>
                        <div class="mb-3">
                            <label for="site_name" class="form-label">Název webu</label>
                            <input type="text" name="site_name" id="site_name" value="{{ values.site_name }}" class="form-control" required>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="allow_registration" name="allow_registration" value="1" {% if values.allow_registration == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="allow_registration">Povolit frontend registrace</label>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="timezone" class="form-label">Časové pásmo</label>
                                <select id="timezone" name="timezone" class="form-select">
                                    {% set currentTz = values.timezone|default(app_settings.timezone) %}
                                    {% for tz in timezones %}
                                        <option value="{{ tz }}" {% if tz == currentTz %}selected{% endif %}>{{ tz }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="date_format" class="form-label">Formát data</label>
                                <select id="date_format" name="date_format" class="form-select">
                                    {% set currentDateFormat = values.date_format|default(app_settings.date_format) %}
                                    {% for format in date_formats %}
                                        <option value="{{ format }}" {% if format == currentDateFormat %}selected{% endif %}>{{ "now"|date(format) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="time_format" class="form-label">Formát času</label>
                                <select id="time_format" name="time_format" class="form-select">
                                    {% set currentTimeFormat = values.time_format|default(app_settings.time_format) %}
                                    {% for format in time_formats %}
                                        <option value="{{ format }}" {% if format == currentTimeFormat %}selected{% endif %}>{{ "now"|date(format) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-1">
                            <div class="col-md-6">
                                <label class="form-label">Logo webu</label>
                                <div class="d-flex align-items-center gap-3 flex-wrap">
                                    <div class="border rounded bg-light p-2" id="siteLogoPreview">
                                        {% if selected_logo %}
                                            <img src="{{ selected_logo.url }}" alt="{{ selected_logo.alt }}" class="img-fluid" style="max-height: 64px;">
                                            <div class="small text-muted mt-1 text-truncate" title="{{ selected_logo.original_name }}">{{ selected_logo.original_name }}</div>
                                        {% else %}
                                            <div class="text-muted small">Zatím nevybráno</div>
                                        {% endif %}
                                    </div>
                                    <input type="hidden" name="site_logo_id" id="site_logo_id" value="{{ values.site_logo_id }}">
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn btn-outline-secondary d-inline-flex align-items-center gap-2" type="button" data-bs-toggle="modal" data-bs-target="#mediaLibraryModal" data-media-action="logo">
                                            <i class="bi bi-images"></i>
                                            <span>Vybrat z knihovny</span>
                                        </button>
                                        <button class="btn btn-outline-danger d-inline-flex align-items-center gap-2" type="button" id="removeSiteLogo">
                                            <i class="bi bi-trash"></i>
                                            <span>Odebrat</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-text">Použije se v navigaci webu.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Favicon</label>
                                <div class="d-flex align-items-center gap-3 flex-wrap">
                                    <div class="border rounded bg-light p-2" id="siteFaviconPreview">
                                        {% if selected_favicon %}
                                            <img src="{{ selected_favicon.url }}" alt="{{ selected_favicon.alt }}" class="img-fluid" style="max-height: 48px;">
                                            <div class="small text-muted mt-1 text-truncate" title="{{ selected_favicon.original_name }}">{{ selected_favicon.original_name }}</div>
                                        {% else %}
                                            <div class="text-muted small">Zatím nevybráno</div>
                                        {% endif %}
                                    </div>
                                    <input type="hidden" name="site_favicon_id" id="site_favicon_id" value="{{ values.site_favicon_id }}">
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn btn-outline-secondary d-inline-flex align-items-center gap-2" type="button" data-bs-toggle="modal" data-bs-target="#mediaLibraryModal" data-media-action="favicon">
                                            <i class="bi bi-images"></i>
                                            <span>Vybrat z knihovny</span>
                                        </button>
                                        <button class="btn btn-outline-danger d-inline-flex align-items-center gap-2" type="button" id="removeSiteFavicon">
                                            <i class="bi bi-trash"></i>
                                            <span>Odebrat</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-text">Zobrazí se v prohlížeči jako ikona webu.</div>
                            </div>
                        </div>

                    {% elseif active_section == 'uploads' %}
                        <h2 class="h5 mb-3">Uploady</h2>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="allow_webp" name="allow_webp" value="1" {% if values.allow_webp == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="allow_webp">Povolit generování WebP variant</label>
                        </div>

                        <div class="mb-3">
                            <label for="allowed_upload_types" class="form-label">Povolené přípony uploadů</label>
                            <input type="text" name="allowed_upload_types" id="allowed_upload_types" value="{{ values.allowed_upload_types }}" class="form-control">
                            <div class="form-text">Zadejte seznam přípon oddělených čárkou (např. jpg,jpeg,png,gif,webp,pdf,zip).</div>
                        </div>

                    {% elseif active_section == 'email' %}
                        <h2 class="h5 mb-3">E-mailové nastavení</h2>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="mail_transport" class="form-label">Způsob odesílání</label>
                                {% set mailTransport = values.mail_transport|default('mail') %}
                                <select id="mail_transport" name="mail_transport" class="form-select">
                                    <option value="mail" {% if mailTransport == 'mail' %}selected{% endif %}>Nativní PHP mail()</option>
                                    <option value="smtp" {% if mailTransport == 'smtp' %}selected{% endif %}>SMTP server</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="smtp_host" class="form-label">SMTP server</label>
                                <input type="text" class="form-control" id="smtp_host" name="smtp_host" value="{{ values.smtp_host }}" placeholder="smtp.example.com">
                            </div>
                            <div class="col-md-3">
                                <label for="smtp_port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="smtp_port" name="smtp_port" value="{{ values.smtp_port|default(587) }}" min="1">
                            </div>
                            <div class="col-md-3">
                                <label for="smtp_encryption" class="form-label">Zabezpečení</label>
                                <select id="smtp_encryption" name="smtp_encryption" class="form-select">
                                    {% set encryption = values.smtp_encryption|default('tls') %}
                                    <option value="" {% if encryption == '' %}selected{% endif %}>Bez šifrování</option>
                                    <option value="tls" {% if encryption == 'tls' %}selected{% endif %}>TLS</option>
                                    <option value="ssl" {% if encryption == 'ssl' %}selected{% endif %}>SSL</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="smtp_username" class="form-label">Uživatelské jméno</label>
                                <input type="text" class="form-control" id="smtp_username" name="smtp_username" value="{{ values.smtp_username }}">
                            </div>
                            <div class="col-md-6">
                                <label for="smtp_password" class="form-label">Heslo</label>
                                <input type="password" class="form-control" id="smtp_password" name="smtp_password" value="{{ values.smtp_password }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="smtp_from_email" class="form-label">Odesílatel (e-mail)</label>
                                <input type="email" class="form-control" id="smtp_from_email" name="smtp_from_email" value="{{ values.smtp_from_email }}" placeholder="noreply@example.com">
                            </div>
                            <div class="col-md-6">
                                <label for="smtp_from_name" class="form-label">Odesílatel (jméno)</label>
                                <input type="text" class="form-control" id="smtp_from_name" name="smtp_from_name" value="{{ values.smtp_from_name }}" placeholder="Moje CMS">
                            </div>
                        </div>

                    {% elseif active_section == 'comments' %}
                        <h2 class="h5 mb-3">Komentáře</h2>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="comments_enabled" name="comments_enabled" value="1" {% if values.comments_enabled == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="comments_enabled">Povolit komentáře globálně</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="comments_allow_replies" name="comments_allow_replies" value="1" {% if values.comments_allow_replies == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="comments_allow_replies">Povolit odpovědi na komentáře</label>
                        </div>

                        <div class="mb-3">
                            <label for="comments_max_depth" class="form-label">Maximální úroveň vláken</label>
                            <input type="number" class="form-control" id="comments_max_depth" name="comments_max_depth" value="{{ values.comments_max_depth|default(2) }}" min="0" max="5">
                            <div class="form-text">0 = zakáže odpovědi, 1 = pouze hlavní komentáře, 5 = hlubší vlákna.</div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="comments_moderation" name="comments_moderation" value="1" {% if values.comments_moderation == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="comments_moderation">Vyžadovat schválení komentářů</label>
                            <div class="form-text">Moderace se uplatní pouze pokud jsou povoleny anonymní komentáře. Přihlášení uživatelé publikují ihned.</div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="comments_allow_anonymous" name="comments_allow_anonymous" value="1" {% if values.comments_allow_anonymous == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="comments_allow_anonymous">Povolit komentáře anonymním uživatelům</label>
                            <div class="form-text">Při vypnutí tohoto nastavení se komentáře povolí pouze přihlášeným účtům a schvalování se nevyužije.</div>
                        </div>

                    {% elseif active_section == 'themes' %}
                        <h2 class="h5 mb-3">Šablony</h2>
                        <p>Vyberte aktivní šablonu, nebo nahrajte novou ve formátu ZIP. Šablony se ukládají do složky <code>themes/</code>.</p>

                        <div class="row g-3">
                            {% if themes %}
                                {% for key, theme in themes %}
                                    <div class="col-md-6">
                                        <div class="border rounded p-3 h-100 {% if key == active_theme %}border-primary{% endif %}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="theme" id="theme_{{ key }}" value="{{ key }}" {% if key == active_theme %}checked{% endif %}>
                                                        <label class="form-check-label fw-semibold" for="theme_{{ key }}">{{ theme.name|default(key) }}</label>
                                                    </div>
                                                    <div class="small text-muted">Verze {{ theme.version|default('1.0.0') }}</div>
                                                </div>
                                                <span class="badge bg-light text-dark">{{ key }}</span>
                                            </div>
                                            {% if theme.description %}
                                                <p class="mt-2 mb-1">{{ theme.description }}</p>
                                            {% endif %}
                                            {% if theme.author %}
                                                <div class="small text-muted">Autor: {{ theme.author }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <div class="alert alert-warning">Nebyly nalezeny žádné šablony. Nahrajte prosím ZIP s šablonou.</div>
                                </div>
                            {% endif %}
                        </div>

                        <hr class="my-4">

                        <div class="mb-3">
                            <label for="theme_package" class="form-label">Nahrát šablonu (ZIP)</label>
                            <input type="file" class="form-control" name="theme_package" id="theme_package" accept=".zip">
                            <div class="form-text">Archiv musí obsahovat šablonu v samostatné složce, doporučeně s <code>theme.json</code> nebo <code>{{ active_theme }}.json</code> popisem.</div>
                        </div>

                    {% elseif active_section == 'content-types' %}
                        <h2 class="h5 mb-3">Typy obsahu</h2>

                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <p class="mb-0 flex-grow-1">
                                Definujte typy obsahu podobně jako ve WordPressu. Každý typ musí mít klíč (používá se v databázi) a slug (pro URL v administraci).
                            </p>
                            <button type="button" class="btn btn-outline-primary ms-auto d-inline-flex align-items-center gap-2" id="addContentType">
                                <i class="bi bi-plus-lg"></i>
                                <span>Přidat typ</span>
                            </button>
                        </div>

                        {% set types = content_types is defined and content_types ? content_types : [] %}
                        {% if types is empty %}
                            {% set types = [
                                { key: 'post', name: 'Příspěvek', plural_name: 'Příspěvky', slug: 'prispevky', menu_label: 'Příspěvky' },
                                { key: 'page', name: 'Stránka', plural_name: 'Stránky', slug: 'stranky', menu_label: 'Stránky' }
                            ] %}
                        {% endif %}

                        <div id="contentTypesList" class="row gy-3">
                            {% for type in types %}
                                <div class="col-12">
                                    <div class="border rounded p-3 bg-light h-100">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="fw-semibold">
                                                {{ type.name }} ({{ type.key }})
                                            </span>
                                            <button type="button" class="btn btn-outline-danger btn-sm btn-icon remove-content-type" title="Smazat typ" aria-label="Smazat typ">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <label class="form-label">Klíč</label>
                                                <input type="text" name="content_types[key][]" class="form-control" value="{{ type.key }}" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Název</label>
                                                <input type="text" name="content_types[name][]" class="form-control" value="{{ type.name }}" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Plurál</label>
                                                <input type="text" name="content_types[plural_name][]" class="form-control" value="{{ type.plural_name|default(type.name ~ 'y') }}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Slug</label>
                                                <input type="text" name="content_types[slug][]" class="form-control" value="{{ type.slug }}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Název v menu</label>
                                                <input type="text" name="content_types[menu_label][]" class="form-control" value="{{ type.menu_label|default(type.plural_name) }}" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                    {% elseif active_section == 'term-types' %}
                        <h2 class="h5 mb-3">Typy termů</h2>

                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <p class="mb-0 flex-grow-1">
                                Stejně jako u typů obsahu si můžete definovat vlastní typy termů (tagy, kategorie...).
                            </p>
                            <button type="button" class="btn btn-outline-primary ms-auto d-inline-flex align-items-center gap-2" id="addTermType">
                                <i class="bi bi-plus-lg"></i>
                                <span>Přidat typ termu</span>
                            </button>
                        </div>

                        {% set termTypes = term_types is defined and term_types ? term_types : [] %}
                        {% if termTypes is empty %}
                            {% set termTypes = [
                                { key: 'tag', label: 'Tag', content_types: [] },
                                { key: 'category', label: 'Kategorie', content_types: [] }
                            ] %}
                        {% endif %}

                        <div id="termTypesList" class="row gy-3">
                            {% for type in termTypes %}
                                <div class="col-12">
                                    <div class="border rounded p-3 bg-light h-100">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="fw-semibold">
                                                {{ type.label }} ({{ type.key }})
                                            </span>
                                            <button type="button" class="btn btn-outline-danger btn-sm btn-icon remove-term-type" title="Smazat typ termu" aria-label="Smazat typ termu">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <label class="form-label">Klíč</label>
                                                <input type="text" name="term_types[key][{{ loop.index0 }}]" class="form-control" value="{{ type.key }}" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Název</label>
                                                <input type="text" name="term_types[label][{{ loop.index0 }}]" class="form-control" value="{{ type.label }}" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Typy obsahu</label>
                                                <select name="term_types[content_types][{{ loop.index0 }}][]" class="form-select" multiple>
                                                    {% set allowed = type.content_types is defined and type.content_types is iterable ? type.content_types : [] %}
                                                    {% for key, contentType in content_types %}
                                                        <option value="{{ key }}" {% if key in allowed %}selected{% endif %}>{{ contentType.name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <div class="form-text">Nevybráno = dostupné všude.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="card-footer bg-light d-flex justify-content-between align-items-center flex-wrap gap-2">
                    {{ ui.back_button('/admin', { label: 'Zpět' }) }}
                    {{ ui.actions([
                        {
                            type: 'button',
                            button_type: 'submit',
                            label: 'Uložit',
                            variant: 'primary',
                            icon: 'bi-save'
                        }
                    ]) }}
                </div>
            </form>
        </div>
    </div>

    {% if active_section == 'main' %}
        <div class="modal fade" id="mediaLibraryModal" tabindex="-1" aria-labelledby="mediaLibraryLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="mediaLibraryLabel">Knihovna médií</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
                    </div>
                    <div class="modal-body">
                        <form id="mediaUploadForm" class="row g-2 align-items-end mb-3" enctype="multipart/form-data">
                            <div class="col-md-6">
                                <label for="mediaFile" class="form-label">Nahrát nový obrázek</label>
                                <input class="form-control" type="file" id="mediaFile" name="file" accept="image/*" required>
                            </div>
                            <div class="col-md-6">
                                <label for="mediaAlt" class="form-label">Alt text</label>
                                <input type="text" id="mediaAlt" name="alt" class="form-control" placeholder="Popis obrázku (nepovinné)">
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Nahrát</button>
                            </div>
                        </form>

                        <div class="row row-cols-2 row-cols-md-4 row-cols-xl-6 g-3" id="mediaLibraryGrid">
                            {% for mediaItem in media %}
                                {% if mediaItem.is_image %}
                                    <div class="col">
                                        <div class="card h-100 media-card" role="button" tabindex="0" data-media-id="{{ mediaItem.id }}" data-media-url="/{{ mediaItem.path }}/{{ mediaItem.webp_filename ?: mediaItem.filename }}" data-media-label="{{ mediaItem.original_name ?: mediaItem.filename }}">
                                            <img src="/{{ mediaItem.path }}/{{ mediaItem.webp_filename ?: mediaItem.filename }}" class="card-img-top" alt="{{ mediaItem.alt }}">
                                            <div class="card-body p-2">
                                                <div class="small text-truncate" title="{{ mediaItem.original_name ?: mediaItem.filename }}">{{ mediaItem.original_name ?: mediaItem.filename }}</div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="alert alert-info mt-3" id="mediaLibraryEmpty" {% if media is not empty %}style="display:none;"{% endif %}>Zatím žádné obrázky.</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavřít</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    {% if active_section == 'main' %}
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const mediaGrid = document.getElementById('mediaLibraryGrid');
                const mediaModalEl = document.getElementById('mediaLibraryModal');
                const mediaEmptyAlert = document.getElementById('mediaLibraryEmpty');
                const logoPreview = document.getElementById('siteLogoPreview');
                const faviconPreview = document.getElementById('siteFaviconPreview');
                const logoInput = document.getElementById('site_logo_id');
                const faviconInput = document.getElementById('site_favicon_id');
                const removeLogoBtn = document.getElementById('removeSiteLogo');
                const removeFaviconBtn = document.getElementById('removeSiteFavicon');
                const mediaUploadForm = document.getElementById('mediaUploadForm');
                const mediaActionButtons = document.querySelectorAll('[data-media-action]');

                let currentMediaAction = 'logo';

                const renderPlaceholder = (target) => {
                    if (!target) return;
                    target.innerHTML = '<div class="text-muted small">Zatím nevybráno</div>';
                };

                const updatePreview = (target, url, label, maxHeight) => {
                    if (!target) return;
                    target.innerHTML = `
                        <img src="${url}" alt="${label}" class="img-fluid" style="max-height:${maxHeight}px;">
                        <div class="small text-muted mt-1 text-truncate" title="${label}">${label}</div>
                    `;
                };

                const assignMedia = (id, url, label) => {
                    const isFavicon = currentMediaAction === 'favicon';
                    const input = isFavicon ? faviconInput : logoInput;
                    const preview = isFavicon ? faviconPreview : logoPreview;
                    const maxHeight = isFavicon ? 48 : 64;

                    if (!input || !preview) {
                        return;
                    }

                    input.value = id;
                    updatePreview(preview, url, label, maxHeight);
                };

                const clearSelection = (type) => {
                    const input = type === 'favicon' ? faviconInput : logoInput;
                    const preview = type === 'favicon' ? faviconPreview : logoPreview;
                    if (input) {
                        input.value = '';
                    }
                    renderPlaceholder(preview);
                };

                mediaActionButtons.forEach((button) => {
                    button.addEventListener('click', () => {
                        currentMediaAction = button.dataset.mediaAction || 'logo';
                    });
                });

                if (removeLogoBtn) {
                    removeLogoBtn.addEventListener('click', () => clearSelection('logo'));
                }

                if (removeFaviconBtn) {
                    removeFaviconBtn.addEventListener('click', () => clearSelection('favicon'));
                }

                if (mediaGrid) {
                    mediaGrid.addEventListener('click', function (event) {
                        const card = event.target.closest('.media-card');
                        if (!card) {
                            return;
                        }

                        const id = card.dataset.mediaId;
                        const url = card.dataset.mediaUrl;
                        const label = card.dataset.mediaLabel;

                        assignMedia(id, url, label);

                        if (mediaModalEl) {
                            const modalInstance = bootstrap.Modal.getOrCreateInstance(mediaModalEl);
                            modalInstance.hide();
                        }
                    });
                }

                const addMediaCard = (id, url, label) => {
                    if (!mediaGrid) return;
                    if (mediaEmptyAlert) {
                        mediaEmptyAlert.style.display = 'none';
                    }

                    const col = document.createElement('div');
                    col.className = 'col';
                    col.innerHTML = `
                        <div class="card h-100 media-card" role="button" tabindex="0" data-media-id="${id}" data-media-url="${url}" data-media-label="${label}">
                            <img src="${url}" class="card-img-top" alt="${label}">
                            <div class="card-body p-2">
                                <div class="small text-truncate" title="${label}">${label}</div>
                            </div>
                        </div>
                    `;

                    mediaGrid.prepend(col);
                };

                if (mediaUploadForm) {
                    mediaUploadForm.addEventListener('submit', async function (event) {
                        event.preventDefault();

                        const formData = new FormData(mediaUploadForm);
                        try {
                            const response = await fetch('/admin/media/upload', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Accept': 'application/json',
                                },
                            });

                            const data = await response.json();
                            if (!response.ok || data.error) {
                                throw new Error(data.error || data.message || 'Nahrávání se nezdařilo.');
                            }

                            if (data.id && data.path) {
                                addMediaCard(data.id, data.path, data.original_name || 'Nový obrázek');
                                assignMedia(data.id, data.path, data.original_name || 'Nový obrázek');
                            }

                            mediaUploadForm.reset();
                        } catch (error) {
                            alert(error.message || 'Nahrávání se nezdařilo.');
                        }
                    });
                }
            });
        </script>
    {% endif %}

    <script>
        (function () {
            // ---------- Typy obsahu ----------
            const contentTypesList = document.getElementById('contentTypesList');
            const addContentTypeButton = document.getElementById('addContentType');

            if (addContentTypeButton && contentTypesList) {
                addContentTypeButton.addEventListener('click', function () {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'col-12';
                    wrapper.innerHTML = `
                        <div class="border rounded p-3 bg-light h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">
                                    Nový typ
                                </span>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-content-type">
                                    Smazat
                                </button>
                            </div>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label">Klíč</label>
                                    <input type="text" name="content_types[key][]" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Název</label>
                                    <input type="text" name="content_types[name][]" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Plurál</label>
                                    <input type="text" name="content_types[plural_name][]" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Slug</label>
                                    <input type="text" name="content_types[slug][]" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Název v menu</label>
                                    <input type="text" name="content_types[menu_label][]" class="form-control" required>
                                </div>
                            </div>
                        </div>
                    `;
                    contentTypesList.appendChild(wrapper);
                });

                contentTypesList.addEventListener('click', function (event) {
                    if (!(event.target instanceof HTMLElement)) return;
                    if (event.target.classList.contains('remove-content-type')) {
                        const col = event.target.closest('.col-12');
                        if (col) {
                            col.parentNode.removeChild(col);
                        }
                    }
                });
            }

            // ---------- Typy termů ----------
            const termTypesList = document.getElementById('termTypesList');
            const addTermTypeButton = document.getElementById('addTermType');
            let termTypeIndex = termTypesList ? termTypesList.querySelectorAll('.col-12').length : 0;
            const termTypeContentOptions = `{% for key, contentType in content_types %}<option value="{{ key }}">{{ contentType.name }}</option>{% endfor %}`;

            if (addTermTypeButton && termTypesList) {
                addTermTypeButton.addEventListener('click', function () {
                    const currentIndex = termTypeIndex++;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'col-12';
                    wrapper.innerHTML = `
                        <div class="border rounded p-3 bg-light h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">
                                    Nový term
                                </span>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-term-type">
                                    Smazat
                                </button>
                            </div>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label">Klíč</label>
                                    <input type="text" name="term_types[key][${currentIndex}]" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Název</label>
                                    <input type="text" name="term_types[label][${currentIndex}]" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Typy obsahu</label>
                                    <select name="term_types[content_types][${currentIndex}][]" class="form-select" multiple>
                                        ${termTypeContentOptions}
                                    </select>
                                    <div class="form-text">Nevybráno = dostupné všude.</div>
                                </div>
                            </div>
                        </div>
                    `;
                    termTypesList.appendChild(wrapper);
                });

                termTypesList.addEventListener('click', function (event) {
                    if (!(event.target instanceof HTMLElement)) return;
                    if (event.target.classList.contains('remove-term-type')) {
                        const col = event.target.closest('.col-12');
                        if (col) {
                            col.parentNode.removeChild(col);
                        }
                    }
                });
            }
        })();
    </script>
{% endblock %}
