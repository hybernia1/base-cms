{% extends 'front/layout.twig' %}

{% set breadcrumbs_enabled = false %}
{% set can_manage_comments = can_manage_comments is defined ? can_manage_comments : (current_user and current_user.role == 'admin') %}

{% block head_extra %}
    {{ parent() }}
    <style>
        .comment-replies {
            margin-left: calc(var(--comment-indent-size) * 0.35);
        }

        .comment-reply-list {
            display: flex;
            flex-direction: column;
            row-gap: calc(var(--comment-gap) * 0.75);
            margin-top: .35rem;
        }

        .comment-thread-item {
            display: flex;
            flex-direction: column;
            row-gap: .65rem;
        }

        .comment-thread-item + .comment-thread-item {
            margin-top: var(--comment-gap);
        }

        .comment-replies.is-thread-root .comment-reply-list {
            margin-top: .5rem;
        }

        .reply-toggle {
            font-weight: 600;
            color: var(--accent);
        }

        .reply-toggle:hover,
        .reply-toggle:focus {
            color: #365fa5;
            text-decoration: none;
        }

        .comment-text .comment-mention {
            font-weight: 600;
            color: var(--accent);
            text-decoration: none;
        }

        .comment-text .comment-mention:hover,
        .comment-text .comment-mention:focus {
            color: #365fa5;
            text-decoration: underline;
        }

        .comment-mention-preview {
            border-left: 3px solid var(--bs-border-color);
            padding-left: .5rem;
            margin-top: .35rem;
            color: var(--bs-body-color);
            font-size: .9rem;
        }

        .comment-mention-body {
            margin-top: .35rem;
        }
    </style>
{% endblock %}

{% block title %}
    Diskuse: {{ content.title }} | {{ type.name|default('Obsah') }}
{% endblock %}

{% block body %}
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="d-flex align-items-center gap-3 mt-4 flex-wrap">
                <div>
                    <h1 class="h4 mb-0">Diskuse: {{ content.title }}</h1>
                </div>
            </div>

            {% set perex = content.excerpt ?: (content.body|default('')|striptags|slice(0, 240)) %}
            {% if perex or thumbnail %}
                <div class="d-flex align-items-start gap-3 mt-3">
                    {% if thumbnail %}
                        <div class="article-thumb flex-shrink-0 d-flex align-items-center justify-content-center text-uppercase fw-bold" aria-hidden="true">
                            <img src="/{{ thumbnail.path }}/{{ thumbnail.webp_filename ?: thumbnail.filename }}" alt="{{ thumbnail.alt ?: content.title }}" loading="lazy" decoding="async">
                        </div>
                    {% endif %}
                    {% if perex %}
                        <p class="mb-0 text-muted">{{ perex }}</p>
                    {% endif %}
                </div>
            {% endif %}

            {% if comment_allowed %}
                <section class="card shadow-sm mt-3">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                            <h2 class="h5 mb-0">Diskuse (<span data-comment-count>{{ comments|length }}</span>)</h2>
                            <a href="{{ content_url }}" class="btn btn-link text-decoration-none p-0">Zpět na článek</a>
                        </div>

                        <div id="commentFormHome">
                            <div id="commentFormWrapper">
                                <form method="post" action="/comments" class="mt-3" id="commentForm">
                                    <input type="hidden" name="content_id" value="{{ content.id }}">
                                    <input type="hidden" name="parent_id" value="">
                                    <input type="hidden" name="reply_depth" value="">
                                    <input type="hidden" name="mention_only" value="0">
                                    <input type="hidden" name="_csrf" value="{{ csrf_token('comment_form') }}">

                                    <div id="replyInfo" class="alert alert-secondary d-none py-2 px-3 mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="small"><span data-reply-label>Odpovídáte na</span> <strong id="replyTarget"></strong></div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="cancelReply">Zrušit</button>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="comment_body" class="form-label">Komentář</label>
                                        <textarea class="form-control" id="comment_body" name="body" rows="4" required {% if not commenting_enabled %}disabled{% endif %}></textarea>
                                    </div>

                                    {% if current_user %}
                                        <div class="alert alert-light border">
                                            Přihlášen jako <strong>{{ current_user.nickname ?: current_user.email }}</strong>. Přezdívka se použije u komentáře.
                                        </div>
                                    {% elseif comment_settings.allow_anonymous %}
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="comment_author" class="form-label">Jméno</label>
                                                <input type="text" class="form-control" id="comment_author" name="author_name" value="" required {% if not commenting_enabled %}disabled{% endif %}>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="comment_email" class="form-label">E-mail</label>
                                                <input type="email" class="form-control" id="comment_email" name="author_email" value="" required {% if not commenting_enabled %}disabled{% endif %}>
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if not commenting_enabled %}
                                        <div class="alert alert-info mt-3">Komentáře jsou povoleny pouze pro přihlášené uživatele.</div>
                                    {% endif %}

                                    <div id="commentAlert" class="alert d-none mt-3" role="alert"></div>

                                    <button type="submit" class="btn btn-primary mt-3" {% if not commenting_enabled %}disabled{% endif %}>Odeslat</button>
                                </form>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="comment-thread" role="list" data-comment-thread>
                            {% if comments %}
                                {% for comment in comments %}
                                    {% set has_parent = comment.depth > 0 %}
                                    {% set is_mention_only = comment.mention_only ?? false %}
                                    {% set base_indent = comment_settings.max_depth is defined ? min(comment.depth, comment_settings.max_depth) : comment.depth %}
                                    {% set indent_depth = (is_mention_only and comment.depth > 0) ? max([base_indent - 1, 0]) : base_indent %}
                                    <article class="comment-item{% if has_parent %} has-parent{% endif %}{% if comment.depth == 0 %} is-root{% endif %}" id="comment-{{ comment.id }}" data-depth="{{ comment.depth }}" data-comment-id="{{ comment.id }}" data-comment-body="{{ comment.body|e('html_attr') }}" data-mention-only="{{ is_mention_only ? '1' : '0' }}" style="--comment-indent: {{ indent_depth }}" role="listitem">
                                        <div class="comment-card">
                                            <div class="comment-inner">
                                                <div class="comment-avatar">
                                                    <span class="avatar avatar-sm bg-primary-subtle text-primary fw-bold flex-shrink-0">
                                                        {% if comment.avatar.url %}
                                                            <img src="{{ comment.avatar.url }}" alt="Avatar {{ comment.author_name ?: 'Anonym' }}" class="rounded-circle" loading="lazy">
                                                        {% else %}
                                                            {{ comment.avatar.initials }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="comment-body">
                                                    <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
                                                        <div>
                                                            <div class="fw-semibold">
                                                                {% if comment.profile_url %}
                                                                    <a href="{{ comment.profile_url }}" class="text-decoration-none">{{ comment.author_name ?: 'Anonym' }}</a>
                                                                {% else %}
                                                                    {{ comment.author_name ?: 'Anonym' }}
                                                                {% endif %}
                                                            </div>
                                                            <div class="text-muted small">{{ comment.created_at|date('j. n. Y H:i') }}</div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 comment-text">{{ comment.body|nl2br }}</div>
                                                    {% set can_thread_reply = comment_settings.allow_replies and comment_settings.max_depth > comment.depth and commenting_enabled %}
                                                    {% set can_mention = comment_settings.allow_replies and comment_settings.max_depth > 0 and comment_settings.max_depth <= comment.depth and commenting_enabled %}
                                                    {% if (can_thread_reply or can_mention) or can_manage_comments %}
                                                        <div class="comment-footer d-flex justify-content-between align-items-center gap-2 flex-wrap">
                                                            <div class="d-flex gap-2 flex-wrap">
                                                                {% if can_thread_reply or can_mention %}
                                                                    <button
                                                                        type="button"
                                                                        class="btn btn-sm btn-outline-primary rounded-pill reply-button"
                                                                        data-reply-id="{{ comment.id }}"
                                                                        data-reply-author="{{ comment.author_name ?: 'Anonym' }}"
                                                                        data-mention-only="{{ can_mention and not can_thread_reply ? '1' : '0' }}"
                                                                        data-reply-depth="{{ comment.depth }}"
                                                                    >
                                                                        <i class="bi bi-reply me-1"></i> Reagovat
                                                                        {% if can_mention and not can_thread_reply %}
                                                                            <span class="visually-hidden">(zmínka)</span>
                                                                        {% endif %}
                                                                    </button>
                                                                {% endif %}
                                                            </div>
                                                            {% if can_manage_comments %}
                                                                <div class="d-flex gap-2 flex-wrap">
                                                                    <button type="button" class="btn btn-sm btn-outline-secondary edit-comment" data-comment-id="{{ comment.id }}" data-comment-body="{{ comment.body|e('html_attr') }}">Upravit</button>
                                                                    <button type="button" class="btn btn-sm btn-outline-danger delete-comment" data-comment-id="{{ comment.id }}">Smazat</button>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </article>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <p class="text-muted mb-0{% if comments %} d-none{% endif %}" data-empty-comments>Buďte první, kdo přidá komentář.</p>
                    </div>
                </section>
            {% else %}
                <div class="alert alert-info mt-4">Diskuse u tohoto obsahu je uzavřena.</div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ parent() }}
    {% if comment_allowed %}
        <script>
            (function() {
                const form = document.getElementById('commentForm');
                if (!form) return;

                const parentField = form.querySelector('input[name="parent_id"]');
                const replyInfo = document.getElementById('replyInfo');
                const replyTarget = document.getElementById('replyTarget');
                const replyLabel = replyInfo ? replyInfo.querySelector('[data-reply-label]') : null;
                const cancelReply = document.getElementById('cancelReply');
                const mentionField = form.querySelector('input[name="mention_only"]');
                const replyDepthField = form.querySelector('input[name="reply_depth"]');
                const formWrapper = document.getElementById('commentFormWrapper');
                const formHome = document.getElementById('commentFormHome');

                const commentBody = document.getElementById('comment_body');
                const alertBox = document.getElementById('commentAlert');
                let isMentionOnly = false;
                let mentionPrefix = '';

                const commentThread = document.querySelector('[data-comment-thread]');
                const emptyState = document.querySelector('[data-empty-comments]');
                const commentCount = document.querySelector('[data-comment-count]');
                const commentSettings = {{ comment_settings|json_encode|raw }};
                const commentingEnabled = {{ commenting_enabled ? 'true' : 'false' }};
                const canManageComments = {{ can_manage_comments ? 'true' : 'false' }};
                const adminCsrfToken = '{{ csrf_token('comment_admin') }}';
                const contentId = {{ content.id }};
                const initialComments = {{ comments|json_encode|raw }};
                const commentMap = new Map();

                const escapeHtml = (value) => {
                    return value
                        ? value.replace(/[&<>'"]/g, (char) => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[char]))
                        : '';
                };

                const nl2br = (text) => escapeHtml(text || '').replace(/\n/g, '<br>');

                const buildCommentIndex = (items = []) => {
                    commentMap.clear();
                    items.forEach((item) => {
                        if (item && item.id !== undefined) {
                            commentMap.set(Number(item.id), item);
                        }
                    });
                };

                const getMentionTarget = (comment) => {
                    if (!comment || !comment.mention_only) {
                        return null;
                    }

                    const parentId = comment.parent_id ? Number(comment.parent_id) : 0;
                    return parentId && commentMap.has(parentId) ? commentMap.get(parentId) : null;
                };

                const formatMentionPreview = (text = '') => {
                    const value = (text || '').trim();
                    if (!value) return '';

                    return value.length > 160 ? `${value.slice(0, 160)}…` : value;
                };

                const updateCount = (count) => {
                    if (commentCount) {
                        commentCount.textContent = count;
                    }
                };

                const toggleEmptyState = (hasComments) => {
                    if (emptyState) {
                        emptyState.classList.toggle('d-none', hasComments);
                    }
                };

                const isFormInteracting = () => {
                    const active = document.activeElement;
                    const isFocused = active && formWrapper && formWrapper.contains(active);
                    const isReplying = formWrapper && formHome && formWrapper.parentElement !== formHome;

                    return Boolean(isFocused || isReplying);
                };

                const moveFormHome = () => {
                    if (formWrapper && formHome && !formHome.contains(formWrapper)) {
                        formHome.appendChild(formWrapper);
                    }
                };

                const resetReply = () => {
                    parentField.value = '';
                    if (mentionField) {
                        mentionField.value = '0';
                    }
                    if (replyDepthField) {
                        replyDepthField.value = '';
                    }
                    if (commentBody && mentionPrefix && commentBody.value.startsWith(mentionPrefix)) {
                        commentBody.value = commentBody.value.slice(mentionPrefix.length);
                    }
                    mentionPrefix = '';
                    isMentionOnly = false;
                    if (replyLabel) {
                        replyLabel.textContent = 'Odpovídáte na';
                    }
                    if (replyTarget) {
                        replyTarget.textContent = '';
                    }
                    if (replyInfo) {
                        replyInfo.classList.add('d-none');
                    }

                    moveFormHome();
                };

                if (cancelReply) {
                    cancelReply.addEventListener('click', resetReply);
                }

                const handleReplyClick = (btn) => {
                    if (commentBody && mentionPrefix && commentBody.value.startsWith(mentionPrefix)) {
                        commentBody.value = commentBody.value.slice(mentionPrefix.length);
                    }

                    isMentionOnly = btn.dataset.mentionOnly === '1';
                    const replyAuthor = btn.dataset.replyAuthor || 'komentář';
                    parentField.value = btn.dataset.replyId;
                    if (replyDepthField) {
                        replyDepthField.value = btn.dataset.replyDepth || '';
                    }
                    if (mentionField) {
                        mentionField.value = isMentionOnly ? '1' : '0';
                    }

                    mentionPrefix = isMentionOnly && replyAuthor ? `@${replyAuthor} ` : '';
                    if (commentBody && mentionPrefix && !commentBody.value.startsWith(mentionPrefix)) {
                        const existingText = commentBody.value.trim();
                        commentBody.value = existingText ? `${mentionPrefix}${existingText}` : mentionPrefix;
                    }

                    if (replyInfo && replyTarget) {
                        replyTarget.textContent = replyAuthor;
                        if (replyLabel) {
                            replyLabel.textContent = isMentionOnly ? 'Zmiňujete' : 'Odpovídáte na';
                        }
                        replyInfo.classList.remove('d-none');
                    }
                    if (formWrapper && commentThread) {
                        const commentItem = btn.closest('.comment-item');
                        if (commentItem) {
                            commentItem.insertAdjacentElement('afterend', formWrapper);
                        }
                    }

                    if (commentBody) {
                        commentBody.focus();
                    }
                };

                const bindReplyButtons = (scope) => {
                    scope.querySelectorAll('.reply-button').forEach((btn) => {
                        btn.addEventListener('click', () => handleReplyClick(btn));
                    });
                };

                const createActionButtons = (comment) => {
                    const maxDepth = Number(commentSettings.max_depth || 0);
                    const canThreadReply = commentSettings.allow_replies && commentingEnabled && (maxDepth === 0 || maxDepth > comment.depth);
                    const canMention = commentSettings.allow_replies && commentingEnabled && maxDepth > 0 && maxDepth <= comment.depth;
                    const hasReply = canThreadReply || canMention;
                    const hasAdmin = canManageComments;

                    if (!hasReply && !hasAdmin) {
                        return null;
                    }

                    const footer = document.createElement('div');
                    footer.className = 'comment-footer d-flex justify-content-between align-items-center gap-2 flex-wrap';

                    const replyWrap = document.createElement('div');
                    replyWrap.className = 'd-flex gap-2 flex-wrap';

                    if (hasReply) {
                        const replyBtn = document.createElement('button');
                        replyBtn.type = 'button';
                        replyBtn.className = 'btn btn-sm btn-outline-primary rounded-pill reply-button';
                        replyBtn.dataset.replyId = comment.id;
                        replyBtn.dataset.replyAuthor = comment.author_name || 'Anonym';
                        replyBtn.dataset.mentionOnly = canMention && !canThreadReply ? '1' : '0';
                        replyBtn.dataset.replyDepth = comment.depth;
                        replyBtn.innerHTML = `<i class="bi bi-reply me-1"></i> Reagovat${canMention && !canThreadReply ? '<span class="visually-hidden">(zmínka)</span>' : ''}`;
                        replyWrap.appendChild(replyBtn);
                    }

                    const adminWrap = document.createElement('div');
                    adminWrap.className = 'd-flex gap-2 flex-wrap';

                    if (hasAdmin) {
                        const editBtn = document.createElement('button');
                        editBtn.type = 'button';
                        editBtn.className = 'btn btn-sm btn-outline-secondary edit-comment';
                        editBtn.dataset.commentId = comment.id;
                        editBtn.dataset.commentBody = comment.body || '';
                        editBtn.textContent = 'Upravit';

                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.className = 'btn btn-sm btn-outline-danger delete-comment';
                        deleteBtn.dataset.commentId = comment.id;
                        deleteBtn.textContent = 'Smazat';

                        adminWrap.appendChild(editBtn);
                        adminWrap.appendChild(deleteBtn);
                    }

                    if (replyWrap.childNodes.length) {
                        footer.appendChild(replyWrap);
                    }
                    if (adminWrap.childNodes.length) {
                        footer.appendChild(adminWrap);
                    }

                    return footer;
                };

                const formatReplyToggleLabel = (count, expanded) => {
                    if (expanded) {
                        return 'Skrýt odpovědi';
                    }

                    if (count === 1) {
                        return 'Zobrazit odpověď';
                    }

                    return `Zobrazit ${count} odpovědi`;
                };

                const groupCommentsByParent = (items = []) => {
                    const byId = new Map();
                    const roots = [];

                    items.forEach((comment) => {
                        byId.set(comment.id, { ...comment, replies: [] });
                    });

                    byId.forEach((comment) => {
                        const parentId = comment.parent_id ? Number(comment.parent_id) : 0;
                        if (parentId && byId.has(parentId)) {
                            byId.get(parentId).replies.push(comment);
                        } else {
                            roots.push(comment);
                        }
                    });

                    return roots;
                };

                const getExpandedThreadIds = () => {
                    const expanded = new Set();

                    if (!commentThread) {
                        return expanded;
                    }

                    commentThread.querySelectorAll('.comment-replies.is-thread-root .reply-toggle[aria-expanded="true"]').forEach((btn) => {
                        const commentItem = btn.closest('.comment-item');
                        const commentId = commentItem ? commentItem.dataset.commentId : null;

                        if (commentId) {
                            expanded.add(Number(commentId));
                        }
                    });

                    return expanded;
                };

                const renderReplies = (comment, isRootThread = false, expandedThreads = new Set()) => {
                    if (!comment.replies || !comment.replies.length) {
                        return null;
                    }

                    const repliesWrapper = document.createElement('div');
                    repliesWrapper.className = 'comment-replies';
                    repliesWrapper.classList.toggle('is-thread-root', isRootThread);

                    const repliesList = document.createElement('div');
                    repliesList.className = 'comment-reply-list';
                    if (isRootThread) {
                        repliesList.classList.add('d-none');
                    }
                    comment.replies.forEach((reply) => {
                        repliesList.appendChild(buildCommentElement(reply, true));
                        const nested = renderReplies(reply, false);
                        if (nested) {
                            repliesList.appendChild(nested);
                        }
                    });

                    if (isRootThread) {
                        const toggleBtn = document.createElement('button');
                        toggleBtn.type = 'button';
                        toggleBtn.className = 'btn btn-link text-decoration-none px-0 reply-toggle';
                        toggleBtn.setAttribute('aria-expanded', 'false');
                        toggleBtn.textContent = formatReplyToggleLabel(comment.replies.length, false);

                        toggleBtn.addEventListener('click', () => {
                            repliesList.classList.toggle('d-none');
                            const expanded = !repliesList.classList.contains('d-none');
                            toggleBtn.textContent = formatReplyToggleLabel(comment.replies.length, expanded);
                            toggleBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                        });

                        if (expandedThreads.has(comment.id)) {
                            repliesList.classList.remove('d-none');
                            toggleBtn.textContent = formatReplyToggleLabel(comment.replies.length, true);
                            toggleBtn.setAttribute('aria-expanded', 'true');
                        }

                        repliesWrapper.appendChild(toggleBtn);
                    }
                    repliesWrapper.appendChild(repliesList);

                    return repliesWrapper;
                };

                const buildCommentElement = (comment, isReply = false) => {
                    const article = document.createElement('article');
                    const hasParent = comment.depth > 0;
                    const maxDepth = Number(commentSettings.max_depth || 0);
                    const baseDepth = maxDepth > 0 ? Math.min(comment.depth, maxDepth) : comment.depth;
                    const indentDepth = comment.mention_only && comment.depth > 0 ? Math.max(baseDepth - 1, 0) : baseDepth;
                    article.className = `comment-item${hasParent ? ' has-parent' : ''}${comment.depth === 0 ? ' is-root' : ''}${isReply ? ' is-reply' : ''}`;
                    article.id = `comment-${comment.id}`;
                    article.dataset.depth = comment.depth;
                    article.dataset.commentId = comment.id;
                    article.dataset.commentBody = comment.body || '';
                    article.dataset.parentId = comment.parent_id || '';
                    article.dataset.mentionOnly = comment.mention_only ? '1' : '0';
                    article.style.setProperty('--comment-indent', indentDepth);
                    article.setAttribute('role', 'listitem');

                    const card = document.createElement('div');
                    card.className = 'comment-card';
                    const inner = document.createElement('div');
                    inner.className = 'comment-inner';

                    const avatarWrap = document.createElement('div');
                    avatarWrap.className = 'comment-avatar';
                    const avatarSpan = document.createElement('span');
                    avatarSpan.className = 'avatar avatar-sm bg-primary-subtle text-primary fw-bold flex-shrink-0';

                    if (comment.avatar && comment.avatar.url) {
                        const img = document.createElement('img');
                        img.src = comment.avatar.url;
                        img.alt = `Avatar ${comment.author_name || 'Anonym'}`;
                        img.loading = 'lazy';
                        img.className = 'rounded-circle';
                        avatarSpan.appendChild(img);
                    } else {
                        avatarSpan.textContent = (comment.avatar && comment.avatar.initials) ? comment.avatar.initials : '';
                    }

                    avatarWrap.appendChild(avatarSpan);

                    const bodyWrap = document.createElement('div');
                    bodyWrap.className = 'comment-body';

                    const header = document.createElement('div');
                    header.className = 'd-flex justify-content-between align-items-start gap-2 flex-wrap';

                    const authorBlock = document.createElement('div');
                    const name = document.createElement('div');
                    name.className = 'fw-semibold';
                    if (comment.profile_url) {
                        const link = document.createElement('a');
                        link.href = comment.profile_url;
                        link.className = 'text-decoration-none';
                        link.textContent = comment.author_name || 'Anonym';
                        name.appendChild(link);
                    } else {
                        name.textContent = comment.author_name || 'Anonym';
                    }
                    const meta = document.createElement('div');
                    meta.className = 'text-muted small';
                    meta.textContent = comment.created_at_formatted || '';
                    authorBlock.appendChild(name);
                    authorBlock.appendChild(meta);

                    header.appendChild(authorBlock);

                    const text = document.createElement('div');
                    text.className = 'mt-2 comment-text';
                    const mentionTarget = getMentionTarget(comment);
                    const mentionPreview = mentionTarget
                        ? (() => {
                            const mentionLabel = `@${mentionTarget.author_name || 'Anonym'}`;
                            const previewText = formatMentionPreview(mentionTarget.body || '');
                            let remainingText = (comment.body || '').trimStart();

                            if (remainingText.startsWith(mentionLabel)) {
                                remainingText = remainingText.slice(mentionLabel.length).trimStart();
                            }

                            const previewHtml = previewText
                                ? `<div class="comment-mention-preview">„${escapeHtml(previewText)}“</div>`
                                : '';
                            const remainingHtml = remainingText
                                ? `<div class="comment-mention-body">${nl2br(remainingText)}</div>`
                                : '';

                            return `<a href="#comment-${mentionTarget.id}" class="comment-mention">${escapeHtml(mentionLabel)}</a>${previewHtml}${remainingHtml}`;
                        })()
                        : '';

                    text.innerHTML = mentionPreview || nl2br(comment.body || '');

                    bodyWrap.appendChild(header);
                    bodyWrap.appendChild(text);

                    const footer = createActionButtons(comment);
                    if (footer) {
                        bodyWrap.appendChild(footer);
                    }

                    inner.appendChild(avatarWrap);
                    inner.appendChild(bodyWrap);
                    card.appendChild(inner);
                    article.appendChild(card);

                    return article;
                };

                const bindAdminButtons = (scope) => {
                    if (!canManageComments) return;

                    scope.querySelectorAll('.edit-comment').forEach((btn) => {
                        btn.addEventListener('click', async () => {
                            const commentId = btn.dataset.commentId;
                            const currentBody = btn.dataset.commentBody || '';
                            const newBody = prompt('Upravit komentář:', currentBody);
                            if (newBody === null) return;

                            const formData = new FormData();
                            formData.append('body', newBody.trim());
                            formData.append('_csrf', adminCsrfToken);

                            try {
                                const response = await fetch(`/comments/${commentId}/edit`, {
                                    method: 'POST',
                                    body: formData,
                                    headers: { 'Accept': 'application/json' },
                                });
                                const data = await response.json();
                                if (alertBox) {
                                    alertBox.textContent = data.message || 'Komentář byl upraven.';
                                    alertBox.className = 'alert mt-3 ' + (data.status === 'success' ? 'alert-success' : 'alert-danger');
                                    alertBox.classList.remove('d-none');
                                }
                                if (data.status === 'success') {
                                    await fetchComments();
                                }
                            } catch (error) {
                                if (alertBox) {
                                    alertBox.textContent = 'Uložení komentáře se nezdařilo.';
                                    alertBox.className = 'alert alert-danger mt-3';
                                    alertBox.classList.remove('d-none');
                                }
                            }
                        });
                    });

                    scope.querySelectorAll('.delete-comment').forEach((btn) => {
                        btn.addEventListener('click', async () => {
                            const commentId = btn.dataset.commentId;
                            const confirmed = confirm('Opravdu chcete smazat tento komentář?');
                            if (!confirmed) return;

                            const formData = new FormData();
                            formData.append('_csrf', adminCsrfToken);

                            try {
                                const response = await fetch(`/comments/${commentId}/delete`, {
                                    method: 'POST',
                                    body: formData,
                                    headers: { 'Accept': 'application/json' },
                                });
                                const data = await response.json();
                                if (alertBox) {
                                    alertBox.textContent = data.message || 'Komentář byl odstraněn.';
                                    alertBox.className = 'alert mt-3 ' + (data.status === 'success' ? 'alert-success' : 'alert-danger');
                                    alertBox.classList.remove('d-none');
                                }
                                if (data.status === 'success') {
                                    await fetchComments();
                                }
                            } catch (error) {
                                if (alertBox) {
                                    alertBox.textContent = 'Smazání komentáře se nezdařilo.';
                                    alertBox.className = 'alert alert-danger mt-3';
                                    alertBox.classList.remove('d-none');
                                }
                            }
                        });
                    });
                };

                const renderComments = (comments = []) => {
                    if (!commentThread) return;
                    if (isFormInteracting()) return;

                    const expandedThreads = getExpandedThreadIds();

                    moveFormHome();
                    buildCommentIndex(comments);
                    commentThread.innerHTML = '';
                    const fragment = document.createDocumentFragment();
                    const roots = groupCommentsByParent(comments);

                    roots.forEach((comment) => {
                        const threadItem = document.createElement('div');
                        threadItem.className = 'comment-thread-item';

                        threadItem.appendChild(buildCommentElement(comment));

                        const replies = renderReplies(comment, true, expandedThreads);
                        if (replies) {
                            threadItem.appendChild(replies);
                        }

                        fragment.appendChild(threadItem);
                    });

                    commentThread.appendChild(fragment);
                    bindReplyButtons(commentThread);
                    bindAdminButtons(commentThread);
                    toggleEmptyState(comments.length > 0);
                    updateCount(comments.length);
                };

                const fetchComments = async () => {
                    try {
                        const response = await fetch(`/comments?content_id=${contentId}`, {
                            headers: { 'Accept': 'application/json' },
                        });
                        const data = await response.json();
                        if (data.status === 'success') {
                            renderComments(data.comments || []);
                        }
                    } catch (error) {
                        // ignore fetch errors
                    }
                };

                bindReplyButtons(document);
                bindAdminButtons(document);
                renderComments(initialComments || []);

                form.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    if (!commentBody || commentBody.value.trim() === '') {
                        if (alertBox) {
                            alertBox.textContent = 'Text komentáře je povinný.';
                            alertBox.className = 'alert alert-danger mt-3';
                            alertBox.classList.remove('d-none');
                        }
                        return;
                    }

                    const formData = new FormData(form);
                    formData.set('parent_id', parentField ? parentField.value : '');
                    formData.set('mention_only', mentionField ? mentionField.value : '0');
                    if (replyDepthField) {
                        formData.set('reply_depth', replyDepthField.value || '');
                    }

                    try {
                        const response = await fetch('/comments', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'Accept': 'application/json',
                            },
                        });

                        const data = await response.json();

                        if (alertBox) {
                            alertBox.textContent = data.message || 'Komentář byl odeslán.';
                            alertBox.className = 'alert mt-3 ' + (data.status === 'success' ? 'alert-success' : 'alert-danger');
                            alertBox.classList.remove('d-none');
                        }

                        if (data.status === 'success') {
                            form.reset();
                            resetReply();
                            await fetchComments();
                        }
                    } catch (error) {
                        if (alertBox) {
                            alertBox.textContent = 'Odeslání komentáře se nezdařilo. Zkuste to prosím znovu.';
                            alertBox.className = 'alert alert-danger mt-3';
                            alertBox.classList.remove('d-none');
                        }
                    }
                });
            })();
        </script>
    {% endif %}
{% endblock %}
