{% extends 'admin/layout.twig' %}

{% set current_menu = current_type.slug %}

{% block title %}{{ heading }} | Administrace{% endblock %}

{% block body %}
    <h1 class="h3 mb-4">{{ heading }}</h1>

    <form method="post" action="{{ form_action }}" class="card shadow-sm mb-3" enctype="multipart/form-data">
        <div class="card-body p-4">
            <div class="mb-3">
                <label for="title" class="form-label">Název</label>
                <input type="text" name="title" id="title" class="form-control {% if errors.title %}is-invalid{% endif %}" value="{{ values.title }}">
                {% if errors.title %}
                    <div class="invalid-feedback">{{ errors.title }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="slug" class="form-label">Slug</label>
                <input type="text" name="slug" id="slug" class="form-control {% if errors.slug %}is-invalid{% endif %}" value="{{ values.slug }}" placeholder="např. muj-prispevek">
                {% if errors.slug %}
                    <div class="invalid-feedback">{{ errors.slug }}</div>
                {% else %}
                    <div class="form-text">Pokud necháš prázdné, vytvoří se automaticky z názvu.</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label">Náhledový obrázek</label>
                <div class="d-flex flex-wrap gap-2 mb-2">
                    <select name="thumbnail_id" id="thumbnailSelect" class="form-select" style="max-width: 320px;">
                        <option value="">Vyberte z médií</option>
                        {% for mediaItem in media %}
                            {% if mediaItem.is_image %}
                                <option value="{{ mediaItem.id }}" data-preview="/{{ mediaItem.path }}/{{ mediaItem.webp_filename ?: mediaItem.filename }}" {% if values.thumbnail_id == mediaItem.id %}selected{% endif %}>
                                    {{ mediaItem.original_name ?: mediaItem.filename }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#mediaLibraryModal">Otevřít knihovnu médií</button>
                </div>
                <div id="thumbnailPreview" class="border rounded p-2 bg-light" style="max-width: 320px;{% if not values.thumbnail_id %} display:none;{% endif %}">
                    {% if values.thumbnail_id %}
                        {% for mediaItem in media %}
                            {% if mediaItem.id == values.thumbnail_id %}
                                <img src="/{{ mediaItem.path }}/{{ mediaItem.webp_filename ?: mediaItem.filename }}" class="img-fluid" alt="{{ mediaItem.alt }}">
                                <div class="small mt-1 text-muted">{{ mediaItem.original_name ?: mediaItem.filename }}</div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="form-text">Vyberte existující obrázek nebo použijte knihovnu médií pro nahrání.</div>
                {% if errors.thumbnail %}
                    <div class="text-danger small">{{ errors.thumbnail }}</div>
                {% endif %}
            </div>

            {% if allowed_term_types is not empty %}
                <div class="mb-4">
                    <label class="form-label">Přidat term</label>
                    <form id="newTermForm" class="card card-body bg-light border" action="/admin/content/{{ current_type.slug }}/terms" method="post">
                        <div class="row g-2 align-items-end">
                            <div class="col-lg-5">
                                <label class="form-label" for="newTermName">Název</label>
                                <input type="text" id="newTermName" name="name" class="form-control" placeholder="např. Kategorie A" required>
                            </div>
                            <div class="col-lg-4">
                                <label class="form-label" for="newTermType">Typ</label>
                                <select id="newTermType" name="type" class="form-select">
                                    {% for typeKey, typeDef in allowed_term_types %}
                                        <option value="{{ typeKey }}">{{ typeDef.label|default(typeKey) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-lg-3">
                                <label class="form-label" for="newTermSlug">Slug (volitelně)</label>
                                <input type="text" id="newTermSlug" name="slug" class="form-control" placeholder="např. kategorie-a">
                            </div>
                        </div>
                        <div class="text-danger small mt-2" id="newTermError" style="display:none;"></div>
                        <div class="text-muted small mt-1">Nové termy se po uložení automaticky zaškrtnou a přidají do seznamu.</div>
                    </form>
                </div>
            {% endif %}

            {% if terms is not empty %}
                <div class="mb-4">
                    <label class="form-label">Termy</label>
                    {% for typeKey, typeTerms in terms %}
                        <div class="mb-2">
                            <div class="fw-semibold">{{ term_types[typeKey].label|default(typeKey) }}</div>
                            <div class="row g-2" data-term-group="{{ typeKey }}">
                                {% if typeTerms is not empty %}
                                    {% for term in typeTerms %}
                                        <div class="col-md-4 term-item">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="terms[{{ typeKey }}][]" value="{{ term.id }}" id="term-{{ term.id }}" {% if term.id in selected_terms %}checked{% endif %}>
                                                <label class="form-check-label" for="term-{{ term.id }}">{{ term.name }}</label>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12 text-muted small empty-term-state">Zatím žádné termy.</div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                    {% if errors.terms %}
                        <div class="text-danger small">{{ errors.terms }}</div>
                    {% endif %}
                </div>
            {% endif %}

            <div class="mb-3">
                <label for="body" class="form-label">Text</label>
                <textarea name="body" id="body" rows="8" class="form-control">{{ values.body }}</textarea>
            </div>
        </div>
        <div class="card-footer bg-light d-flex justify-content-between align-items-center">
            <a href="/admin/content/{{ current_type.slug }}" class="btn btn-outline-secondary">Zpět</a>
            <button class="btn btn-primary" type="submit">Uložit</button>
        </div>
    </form>

    {% if content_id is defined %}
        <form action="/admin/content/{{ current_type.slug }}/{{ content_id }}/delete" method="post" onsubmit="return confirm('Opravdu smazat?');">
            <button class="btn btn-outline-danger" type="submit">Smazat</button>
        </form>
    {% endif %}

    <div class="modal fade" id="mediaLibraryModal" tabindex="-1" aria-labelledby="mediaLibraryLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mediaLibraryLabel">Knihovna médií</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
                </div>
                <div class="modal-body">
                    <form id="mediaUploadForm" class="row g-2 align-items-end mb-3" enctype="multipart/form-data">
                        <div class="col-md-5">
                            <label class="form-label" for="libraryFile">Soubor</label>
                            <input type="file" id="libraryFile" name="file" class="form-control" required>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label" for="libraryAlt">Alt text / popisek</label>
                            <input type="text" id="libraryAlt" name="alt" class="form-control" placeholder="Volitelný popis">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" type="submit">Nahrát</button>
                        </div>
                        <div class="col-12">
                            <div class="small text-muted">Nahrané soubory se okamžitě přidají do knihovny bez obnovení stránky.</div>
                        </div>
                    </form>

                    <div class="row row-cols-2 row-cols-md-4 row-cols-xl-6 g-3" id="mediaLibraryGrid">
                        {% for mediaItem in media %}
                            {% if mediaItem.is_image %}
                                <div class="col">
                                    <div class="card h-100 media-card" role="button" tabindex="0" data-media-id="{{ mediaItem.id }}" data-media-url="/{{ mediaItem.path }}/{{ mediaItem.webp_filename ?: mediaItem.filename }}" data-media-label="{{ mediaItem.original_name ?: mediaItem.filename }}">
                                        <img src="/{{ mediaItem.path }}/{{ mediaItem.webp_filename ?: mediaItem.filename }}" class="card-img-top" alt="{{ mediaItem.alt }}">
                                        <div class="card-body p-2">
                                            <div class="small text-truncate" title="{{ mediaItem.original_name ?: mediaItem.filename }}">{{ mediaItem.original_name ?: mediaItem.filename }}</div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="alert alert-info mt-3" id="mediaLibraryEmpty" {% if media is not empty %}style="display:none;"{% endif %}>Zatím žádné obrázky.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavřít</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const thumbnailSelect = document.getElementById('thumbnailSelect');
        const thumbnailPreview = document.getElementById('thumbnailPreview');
        const mediaGrid = document.getElementById('mediaLibraryGrid');
        const mediaModalEl = document.getElementById('mediaLibraryModal');
        const mediaEmptyAlert = document.getElementById('mediaLibraryEmpty');

        function updatePreview(url, label) {
            if (!thumbnailPreview) return;
            if (!url) {
                thumbnailPreview.style.display = 'none';
                thumbnailPreview.innerHTML = '';
                return;
            }

            thumbnailPreview.style.display = '';
            thumbnailPreview.innerHTML = `<img src="${url}" class="img-fluid" alt="">` +
                `<div class="small mt-1 text-muted">${label || ''}</div>`;
        }

        if (thumbnailSelect) {
            thumbnailSelect.addEventListener('change', function () {
                const option = thumbnailSelect.selectedOptions[0];
                const previewUrl = option ? option.dataset.preview : '';
                updatePreview(previewUrl || '', option ? option.textContent : '');
            });

            if (thumbnailSelect.value) {
                const option = thumbnailSelect.selectedOptions[0];
                if (option && option.dataset.preview) {
                    updatePreview(option.dataset.preview, option.textContent);
                }
            }
        }

        function setSelectedThumbnail(id, url, label) {
            if (!thumbnailSelect) return;
            let option = thumbnailSelect.querySelector(`option[value="${id}"]`);
            if (!option) {
                option = document.createElement('option');
                option.value = id;
                thumbnailSelect.appendChild(option);
            }
            option.textContent = label || `Médium #${id}`;
            option.dataset.preview = url;
            thumbnailSelect.value = id;
            updatePreview(url, option.textContent);
        }

        if (mediaGrid) {
            mediaGrid.addEventListener('click', function (event) {
                const card = event.target.closest('.media-card');
                if (!card) return;

                const id = card.dataset.mediaId;
                const url = card.dataset.mediaUrl;
                const label = card.dataset.mediaLabel;
                setSelectedThumbnail(id, url, label);

                if (mediaModalEl) {
                    const modalInstance = bootstrap.Modal.getInstance(mediaModalEl);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
            });

            if (mediaEmptyAlert) {
                mediaEmptyAlert.style.display = mediaGrid.querySelector('.media-card') ? 'none' : '';
            }
        }

        const mediaUploadForm = document.getElementById('mediaUploadForm');
        if (mediaUploadForm) {
            mediaUploadForm.addEventListener('submit', async function (event) {
                event.preventDefault();

                const formData = new FormData(mediaUploadForm);
                try {
                    const response = await fetch('/admin/media/upload', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        }
                    });

                    const result = await response.json();
                    if (!response.ok || result.error) {
                        alert(result.error || 'Nahrávání se nezdařilo.');
                        return;
                    }

                    if (!result.is_image) {
                        alert('Vybraný soubor není obrázek.');
                        return;
                    }

                    appendMediaCard(result.id, result.path, result.original_name);
                    setSelectedThumbnail(result.id, result.path, result.original_name);
                    mediaUploadForm.reset();
                } catch (error) {
                    alert('Nahrávání se nezdařilo.');
                }
            });
        }

        function appendMediaCard(id, url, label) {
            if (!mediaGrid) return;
            if (mediaEmptyAlert) {
                mediaEmptyAlert.style.display = 'none';
            }

            const col = document.createElement('div');
            col.className = 'col';
            col.innerHTML = `
                <div class="card h-100 media-card" role="button" tabindex="0" data-media-id="${id}" data-media-url="${url}" data-media-label="${label}">
                    <img src="${url}" class="card-img-top" alt="">
                    <div class="card-body p-2">
                        <div class="small text-truncate" title="${label}">${label}</div>
                    </div>
                </div>
            `;
            mediaGrid.prepend(col);
        }

        const newTermForm = document.getElementById('newTermForm');
        const newTermError = document.getElementById('newTermError');

        function showTermError(message) {
            if (!newTermError) return;
            newTermError.textContent = message;
            newTermError.style.display = '';
        }

        function clearTermError() {
            if (!newTermError) return;
            newTermError.textContent = '';
            newTermError.style.display = 'none';
        }

        function appendTermCheckbox(typeKey, id, name, checked = false) {
            const group = document.querySelector(`[data-term-group="${typeKey}"]`);
            if (!group) {
                return;
            }

            const emptyState = group.querySelector('.empty-term-state');
            if (emptyState) {
                emptyState.remove();
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'col-md-4 term-item';
            wrapper.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="terms[${typeKey}][]" value="${id}" id="term-${id}">
                    <label class="form-check-label" for="term-${id}">${name}</label>
                </div>
            `;

            group.prepend(wrapper);

            const checkbox = wrapper.querySelector('input[type="checkbox"]');
            if (checked && checkbox) {
                checkbox.checked = true;
            }
        }

        if (newTermForm) {
            newTermForm.addEventListener('submit', async function (event) {
                event.preventDefault();
                clearTermError();

                const formData = new FormData(newTermForm);

                try {
                    const response = await fetch(newTermForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json',
                        },
                    });

                    const result = await response.json();
                    if (!response.ok || result.error) {
                        showTermError(result.error || 'Vytvoření termu se nezdařilo.');
                        return;
                    }

                    appendTermCheckbox(result.type, result.id, result.name, true);
                    newTermForm.reset();
                } catch (error) {
                    showTermError('Vytvoření termu se nezdařilo.');
                }
            });
        }
    </script>
{% endblock %}
