{% extends 'front/layout.twig' %}

{% block title %}
    {% if item %}{{ item.title }} | {{ type.name|default('Obsah') }}{% else %}Nenalezeno{% endif %}
{% endblock %}

{% block head_extra %}
    {% set description = (item.excerpt ?: (item.body|default('')|striptags|slice(0, 240))) %}
    {% if description %}
        <meta name="description" content="{{ description|striptags }}">
    {% endif %}

    {% set og_image = thumbnail ? base_url ~ '/' ~ thumbnail.path ~ '/' ~ (thumbnail.webp_filename ?: thumbnail.filename) : null %}
    {% if current_url is defined %}
        <meta property="og:url" content="{{ current_url }}">
        <meta property="og:type" content="article">
    {% endif %}
    <meta property="og:title" content="{{ item.title }}">
    {% if description %}<meta property="og:description" content="{{ description|striptags }}">{% endif %}
    {% if og_image %}<meta property="og:image" content="{{ og_image }}">{% endif %}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ item.title }}">
    {% if description %}<meta name="twitter:description" content="{{ description|striptags }}">{% endif %}
    {% if og_image %}<meta name="twitter:image" content="{{ og_image }}">{% endif %}

    {% set schema_data = {
        '@context': 'https://schema.org',
        '@type': item.schema_type|default('Article'),
        'headline': item.title,
        'description': description,
        'datePublished': item.publish_at is defined and item.publish_at ? item.publish_at|date('c') : null,
        'dateModified': item.updated_at is defined and item.updated_at ? item.updated_at|date('c') : null,
        'author': author ? {'@type': 'Person', 'name': author.nickname} : null,
        'image': og_image,
        'mainEntityOfPage': current_url,
        'url': current_url,
        'publisher': site.name is defined ? {'@type': 'Organization', 'name': site.name} : null
    } %}
    <script type="application/ld+json">{{ schema_data|json_encode(constant('JSON_UNESCAPED_UNICODE') b-or constant('JSON_UNESCAPED_SLASHES'))|raw }}</script>
{% endblock %}

{% block body %}
    <div class="row gy-5">
        <div class="col-12 col-lg-8">
            {% if not item %}
                <div class="alert alert-warning mt-4">Obsah nebyl nalezen.</div>
            {% else %}
                <article class="article-shell mt-4">
                    <h1 class="article-title">{{ item.title }}</h1>

                    {% if author %}
                        <div class="d-flex align-items-center gap-3 mt-3 mb-3">
                            <span class="avatar avatar-sm bg-primary-subtle text-primary fw-bold">
                                {% if author.avatar.url %}
                                    <img src="{{ author.avatar.url }}" alt="Avatar {{ author.nickname }}" class="rounded-circle" loading="lazy">
                                {% else %}
                                    {{ author.avatar.initials }}
                                {% endif %}
                            </span>
                            <div class="d-flex flex-column">
                                <span class="fw-semibold">{{ author.nickname }}</span>
                                <span class="text-muted small">{{ item.created_at|date('j. F Y, H:i') }}</span>
                            </div>
                        </div>
                    {% elseif item.created_at is defined %}
                        <div class="text-muted small mt-3 mb-3">{{ item.created_at|date('j. F Y, H:i') }}</div>
                    {% endif %}

                    {% if item.excerpt %}
                        <p class="article-subtitle mt-2 mb-3">{{ item.excerpt }}</p>
                    {% endif %}

                    {% if thumbnail %}
                        <figure class="article-figure">
                            <img src="/{{ thumbnail.path }}/{{ thumbnail.webp_filename ?: thumbnail.filename }}" alt="{{ thumbnail.alt ?: item.title }}" loading="lazy" decoding="async">
                        </figure>
                    {% endif %}

                    {% if terms %}
                        <div class="mb-3 d-flex flex-wrap gap-2">
                            {% for term in terms %}
                                <a href="/terms/{{ term.type }}/{{ term.slug }}" class="badge text-bg-light border text-decoration-none">{{ term.name }}</a>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="content-body">
                        {{ (rendered_body ?? item.body)|raw }}
                    </div>

                    {% if meta_values %}
                        <div class="mt-4">
                            <h2 class="h6 mb-3">Meta údaje</h2>
                            <dl class="row g-3">
                                {% for key, value in meta_values %}
                                    <dt class="col-sm-4 text-muted">{{ meta_definitions[key].name|default(key) }}</dt>
                                    <dd class="col-sm-8 mb-0">{{ value }}</dd>
                                {% endfor %}
                            </dl>
                        </div>
                    {% endif %}
                </article>

                {% if comment_allowed %}
                    <div class="mt-4">
                        <a class="btn btn-outline-primary" href="/{{ type.slug }}/{{ item.slug }}/comments">
                            Vstoupit do diskuse ({{ comments|length }})
                        </a>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        {% if related_posts %}
            <aside class="col-12 col-lg-4">
                <div class="article-stack card article-list h-100 related-posts-card">
                    <div class="card-body d-flex flex-column">
                        <h2 class="h5 mb-3">Další příspěvky</h2>
                        <div class="article-list-body d-flex flex-column gap-3">
                            {% for post in related_posts %}
                                {% set type_def = content_types[post.type]|default({'slug': post.type, 'name': post.type}) %}
                                {% set thumb = post.thumbnail ?? null %}
                                <article class="article-row d-flex gap-3 align-items-center">
                                    <div class="article-thumb flex-shrink-0 d-flex align-items-center justify-content-center text-uppercase fw-bold" aria-hidden="true">
                                        {% if thumb %}
                                            <img src="/{{ thumb.path }}/{{ thumb.webp_filename ?: thumb.filename }}" alt="{{ thumb.alt ?: post.title }}" loading="lazy" decoding="async">
                                        {% else %}
                                            {{ post.title|default('A')|slice(0, 1) }}
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="article-meta mb-1">{{ post.created_at|date('j. n. Y') }}</p>
                                        <h3 class="h6 mb-1">
                                            <a href="/{{ type_def.slug }}/{{ post.slug }}" class="stretched-link text-decoration-none">{{ post.title }}</a>
                                        </h3>
                                        {% set preview = post.excerpt ?: post.body %}

                                    </div>
                                </article>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </aside>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    {{ parent() }}
{% endblock %}

