{# src/App/View/front/layout.twig #}
<!doctype html>
<html lang="cs">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ site.name|default('Můj web') }}{% endblock %}</title>
    {% if seo is defined and not seo.indexing_enabled %}
        <meta name="robots" content="noindex, nofollow">
    {% endif %}
    {% if current_url is defined %}
        <link rel="canonical" href="{{ current_url }}">
    {% endif %}
    {% if site.favicon and site.favicon.url %}
        <link rel="icon" href="{{ site.favicon.url }}" type="{{ site.favicon.mime_type ?: 'image/x-icon' }}">
    {% endif %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/assets/css/admin-bar.css">
    {% if hooks is defined and hooks.head is defined %}
        {% for snippet in hooks.head %}
            {{ snippet|raw }}
        {% endfor %}
    {% endif %}
    {% block head_extra %}{% endblock %}
    <style>
        body { background-color: #f8fafc; }
        header { background: #0d6efd; color: #fff; }
        header a { color: #fff; text-decoration: none; }
        .site-brand { font-weight: 700; letter-spacing: .5px; }
        .site-logo { height: 32px; width: auto; }
        main { padding: 2rem 0 3rem; }
        footer { padding: 2rem 0; color: #6c757d; }
        .content-body p { margin-bottom: 1rem; }
        .dropdown-submenu .dropdown-menu {
            position: static;
        }
        .dropdown-menu .dropdown-menu {
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="{% if admin_bar is defined and admin_bar %}has-admin-bar{% endif %}" data-ajax-enabled="true">
{% import 'admin/partials/admin_bar.twig' as admin_ui %}
{% if admin_bar is defined and admin_bar %}
    {{ admin_ui.admin_bar({
        dashboard_url: admin_bar.dashboard_url,
        edit_url: admin_bar.edit_url|default(null),
        create_links: admin_bar.create_links|default([]),
        user_role_label: admin_bar.user_role_label,
        user_label: admin_bar.user_label,
        user_links: admin_bar.user_links|default([])
    }) }}
{% endif %}
<header data-ajax-fragment="header">
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand site-brand d-flex align-items-center gap-2" href="/">
                {% if site.logo and site.logo.url %}
                    <img src="{{ site.logo.url }}" alt="{{ site.logo.alt ?: site.name }}" class="site-logo">
                {% endif %}
                <span>{{ site.name|default('Base CMS') }}</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Přepnout navigaci">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNavbar">
                {% import _self as nav %}
                {% set nav_items = [] %}
                {% for item in navigation|default([]) %}
                    {% if not ((current_user and item.type in ['core_login', 'core_register']) or (not current_user and item.type in ['core_profile', 'core_logout'])) %}
                        {% set nav_items = nav_items|merge([item]) %}
                    {% endif %}
                {% endfor %}

                {% if nav_items is empty %}
                    {% set nav_items = [
                        {'label': 'Domů', 'url': '/', 'children': [], 'type': 'core_home', 'open_in_new_tab': false},
                        {'label': 'Archiv', 'url': '/' ~ post_archive_slug, 'children': [], 'type': 'archive', 'open_in_new_tab': false},
                        {'label': current_user ? 'Můj profil' : 'Přihlášení', 'url': current_user ? '/profile' : '/login', 'children': [], 'type': current_user ? 'core_profile' : 'core_login', 'open_in_new_tab': false},
                    ] %}
                {% endif %}

                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
                    {% for item in nav_items %}
                        {{ nav.nav_item(item) }}
                    {% endfor %}
                    <li class="nav-item w-100 w-lg-auto ms-lg-3">
                        <form class="d-flex" role="search" method="get" action="/search">
                            <label class="visually-hidden" for="navSearch">Hledat</label>
                            <input class="form-control form-control-sm me-2" type="search" name="q" id="navSearch" placeholder="Hledat…" aria-label="Hledat" minlength="2" required>
                            <button class="btn btn-outline-light btn-sm" type="submit" aria-label="Odeslat vyhledávání" title="Hledat">
                                <i class="bi bi-search" aria-hidden="true"></i>
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<main class="container" data-ajax-container>
    <div class="visually-hidden" role="status" aria-live="polite" data-ajax-loader>Načítám obsah…</div>
    {% if flash_success %}
        {% for msg in flash_success %}
            <div class="alert alert-success">{{ msg }}</div>
        {% endfor %}
    {% endif %}
    {% if flash_error %}
        {% for msg in flash_error %}
            <div class="alert alert-danger">{{ msg }}</div>
        {% endfor %}
    {% endif %}

    {% block body %}{% endblock %}
</main>

<footer class="container" data-ajax-fragment="footer">© {{ "now"|date('Y') }} {{ site.name|default('Base CMS') }}</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% block scripts %}{% endblock %}
{% if hooks is defined and hooks.footer is defined %}
    {% for snippet in hooks.footer %}
        {{ snippet|raw }}
    {% endfor %}
{% endif %}
<script>
    (() => {
        const supportsHistory = Boolean(window.history && window.history.pushState);
        const container = document.querySelector('[data-ajax-container]');
        const loader = document.querySelector('[data-ajax-loader]');

        if (!supportsHistory || !container) {
            return;
        }

        const updateHead = (doc) => {
            const title = doc.querySelector('title');
            if (title) {
                document.title = title.textContent;
            }

            const currentCanonical = document.querySelector('link[rel="canonical"]');
            const nextCanonical = doc.querySelector('link[rel="canonical"]');

            if (nextCanonical) {
                if (currentCanonical) {
                    currentCanonical.replaceWith(nextCanonical.cloneNode(true));
                } else {
                    document.head.appendChild(nextCanonical.cloneNode(true));
                }
            }

            const metaRobots = document.querySelector('meta[name="robots"]');
            const nextRobots = doc.querySelector('meta[name="robots"]');

            if (metaRobots && nextRobots) {
                metaRobots.setAttribute('content', nextRobots.getAttribute('content'));
            } else if (!metaRobots && nextRobots) {
                document.head.appendChild(nextRobots.cloneNode(true));
            }
        };

        const replaceFragment = (doc, selector) => {
            const next = doc.querySelector(selector);
            const current = document.querySelector(selector);
            if (next && current) {
                current.replaceWith(next);
            }
        };

        const replaceContent = (html, url, pushState = true) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const nextContent = doc.querySelector('[data-ajax-container]');

            if (!nextContent) {
                window.location.href = url;
                return;
            }

            updateHead(doc);
            replaceFragment(doc, '[data-ajax-fragment="header"]');
            replaceFragment(doc, '[data-ajax-fragment="footer"]');

            container.innerHTML = nextContent.innerHTML;

            if (pushState) {
                window.history.pushState({ url }, '', url);
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const startLoading = () => {
            if (loader) {
                loader.classList.remove('visually-hidden');
            }
        };

        const stopLoading = () => {
            if (loader) {
                loader.classList.add('visually-hidden');
            }
        };

        const navigate = (url, pushState = true) => {
            startLoading();
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then((response) => response.text())
                .then((html) => replaceContent(html, url, pushState))
                .catch(() => window.location.assign(url))
                .finally(() => stopLoading());
        };

        document.addEventListener('click', (event) => {
            const anchor = event.target.closest('a');

            if (!anchor || anchor.dataset.noAjax === 'true') {
                return;
            }

            const url = anchor.href;
            const isSameOrigin = url && url.startsWith(window.location.origin);
            const isHashOnly = anchor.getAttribute('href')?.startsWith('#');

            if (!isSameOrigin || anchor.target === '_blank' || anchor.hasAttribute('download') || isHashOnly) {
                return;
            }

            event.preventDefault();
            navigate(url, true);
        });

        document.addEventListener('submit', (event) => {
            const form = event.target;

            if (form.dataset.noAjax === 'true') {
                return;
            }

            const method = (form.getAttribute('method') || 'get').toLowerCase();
            const action = form.getAttribute('action') || window.location.href;

            if (method !== 'get') {
                return;
            }

            const url = new URL(action, window.location.origin);
            const formData = new FormData(form);

            formData.forEach((value, key) => {
                url.searchParams.set(key, value);
            });

            event.preventDefault();
            navigate(url.toString(), true);
        });

        window.addEventListener('popstate', () => {
            navigate(window.location.href, false);
        });
    })();
</script>
{% macro nav_item(item) %}
    {% set hasChildren = item.children is defined and item.children|length > 0 %}
    {% set target = item.open_in_new_tab ? '_blank' : '_self' %}
    {% set rel = item.open_in_new_tab ? 'noopener' : null %}
    {% if hasChildren %}
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="{{ item.url ?? '#' }}" role="button" data-bs-toggle="dropdown" aria-expanded="false" target="{{ target }}" {% if rel %}rel="{{ rel }}"{% endif %}>{{ item.label }}</a>
            <ul class="dropdown-menu">
                {% for child in item.children %}
                    {{ _self.dropdown_item(child) }}
                {% endfor %}
            </ul>
        </li>
    {% else %}
        <li class="nav-item">
            <a class="nav-link" href="{{ item.url }}" target="{{ target }}" {% if rel %}rel="{{ rel }}"{% endif %}>{{ item.label }}</a>
        </li>
    {% endif %}
{% endmacro %}

{% macro dropdown_item(item, level = 0) %}
    {% set hasChildren = item.children is defined and item.children|length > 0 %}
    {% set target = item.open_in_new_tab ? '_blank' : '_self' %}
    {% set rel = item.open_in_new_tab ? 'noopener' : null %}
    <li class="{% if hasChildren %}dropdown-submenu{% endif %}">
        <a class="dropdown-item d-flex align-items-center justify-content-between" href="{{ item.url }}" target="{{ target }}" {% if rel %}rel="{{ rel }}"{% endif %}>
            <span style="padding-left: {{ (level + 1) * 8 }}px;">{{ item.label }}</span>
            {% if hasChildren %}<i class="bi bi-chevron-right small"></i>{% endif %}
        </a>
        {% if hasChildren %}
            <ul class="dropdown-menu position-static border-0 shadow-none ps-2 show">
                {% for child in item.children %}
                    {{ _self.dropdown_item(child, level + 1) }}
                {% endfor %}
            </ul>
        {% endif %}
    </li>
{% endmacro %}
</body>
</html>
