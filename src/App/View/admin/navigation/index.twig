{% extends 'admin/layout.twig' %}
{% set current_menu = 'navigation' %}

{% block title %}Navigace{% endblock %}

{% block body %}
    <div class="d-flex align-items-center mb-4">
        <div>
            <div class="text-muted small">Přizpůsobení</div>
            <h1 class="h3 mb-0">Navigace</h1>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3">{{ edit_id ? 'Upravit položku' : 'Nová položka' }}</h5>
                    <form method="post" action="{{ edit_id ? '/admin/navigation/' ~ edit_id ~ '/edit' : '/admin/navigation/create' }}">
                        <div class="mb-3">
                            <label class="form-label">Název odkazu</label>
                            <input type="text" name="label" class="form-control {% if errors.label %}is-invalid{% endif %}"
                                   value="{{ values.label|e }}" required>
                            {% if errors.label %}<div class="invalid-feedback">{{ errors.label }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Typ</label>
                            <select name="type" class="form-select {% if errors.type %}is-invalid{% endif %}" required>
                                {% for key, label in types %}
                                    <option value="{{ key }}" {% if values.type == key %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            {% if errors.type %}<div class="invalid-feedback">{{ errors.type }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cílová URL (pro vlastní odkaz)</label>
                            <input type="url" name="url" class="form-control {% if errors.url %}is-invalid{% endif %}"
                                   value="{{ values.url|e }}" placeholder="https://example.com">
                            {% if errors.url %}<div class="invalid-feedback">{{ errors.url }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Obsah (pro odkaz na obsah)</label>
                            <select name="content_id" class="form-select {% if errors.target_id %}is-invalid{% endif %}">
                                <option value="">— Vyberte obsah —</option>
                                {% for content in content_options %}
                                    <option value="{{ content.id }}" {% if values.content_id == content.id %}selected{% endif %}>
                                        {{ content.title }} ({{ content.type }})
                                    </option>
                                {% endfor %}
                            </select>
                            {% if errors.target_id %}<div class="invalid-feedback">{{ errors.target_id }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Term (pro odkaz na term)</label>
                            <select name="term_id" class="form-select {% if errors.target_id %}is-invalid{% endif %}">
                                <option value="">— Vyberte term —</option>
                                {% for term in term_options %}
                                    <option value="{{ term.id }}" {% if values.term_id == term.id %}selected{% endif %}>
                                        {{ term.name }} ({{ term.type }})
                                    </option>
                                {% endfor %}
                            </select>
                            {% if errors.target_id %}<div class="invalid-feedback">{{ errors.target_id }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Archiv (typ obsahu)</label>
                            <select name="target_key" class="form-select {% if errors.target_key %}is-invalid{% endif %}">
                                <option value="">— Vyberte typ obsahu —</option>
                                {% for key, type in content_types %}
                                    <option value="{{ key }}" {% if values.target_key == key %}selected{% endif %}>
                                        {{ type.menu_label|default(type.plural_name|default(key)) }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if errors.target_key %}<div class="invalid-feedback">{{ errors.target_key }}</div>{% endif %}
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Rodič</label>
                                <select name="parent_id" class="form-select {% if errors.parent_id %}is-invalid{% endif %}">
                                    <option value="">— Bez rodiče —</option>
                                    {% for option in parent_options %}
                                        <option value="{{ option.id }}" {% if values.parent_id == option.id %}selected{% endif %}>
                                            {{ option.label }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if errors.parent_id %}<div class="invalid-feedback">{{ errors.parent_id }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pořadí</label>
                                <input type="number" name="position" min="0" class="form-control" value="{{ values.position|default(0) }}">
                            </div>
                        </div>

                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" name="open_in_new_tab" value="1" id="openNewTab"
                                   {% if values.open_in_new_tab %}checked{% endif %}>
                            <label class="form-check-label" for="openNewTab">
                                Otevřít v novém okně
                            </label>
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">{{ edit_id ? 'Uložit změny' : 'Přidat položku' }}</button>
                            {% if edit_id %}
                                <a href="/admin/navigation" class="btn btn-outline-secondary">Zrušit</a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="card-title mb-0">Položky navigace</h5>
                        <span class="text-muted small">Neplatné odkazy se automaticky skryjí na webu.</span>
                    </div>
                    {% if items %}
                        <ul class="list-group list-group-flush">
                            {% import _self as nav %}
                            {{ nav.render_items(items) }}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">Navigace zatím neobsahuje žádné položky.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% macro render_items(items, level = 0) %}
    {% for item in items %}
        <li class="list-group-item">
            <div class="d-flex align-items-start justify-content-between">
                <div style="margin-left: {{ level * 12 }}px;">
                    <div class="fw-semibold">{{ item.label }}</div>
                    <div class="text-muted small">{{ item.type }}{% if item.url %} · {{ item.url }}{% endif %}</div>
                    {% if not item.is_valid and item.note %}
                        <div class="text-danger small">{{ item.note }}</div>
                    {% endif %}
                </div>
                <div class="d-flex gap-2">
                    <a href="/admin/navigation?edit={{ item.id }}" class="btn btn-sm btn-outline-primary">Upravit</a>
                    <form method="post" action="/admin/navigation/{{ item.id }}/delete" onsubmit="return confirm('Opravdu chcete položku smazat?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Smazat</button>
                    </form>
                </div>
            </div>
            {% if item.children %}
                <ul class="list-group list-group-flush ms-4 mt-2">
                    {{ _self.render_items(item.children, level + 1) }}
                </ul>
            {% endif %}
        </li>
    {% endfor %}
{% endmacro %}
