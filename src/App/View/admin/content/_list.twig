{% import 'admin/partials/components.twig' as ui %}

{% set df = app_settings.date_format|default('d.m.Y') %}
{% set tf = app_settings.time_format|default('H:i') %}

{% set search_hidden = {} %}
{% if current_status and current_status != 'all' %}
    {% set search_hidden = search_hidden|merge({ status: current_status }) %}
{% endif %}

{{ ui.search_form('/admin/content/' ~ current_type.slug, {
    query: search|default(''),
    placeholder: 'Hledat v názvu, slugu nebo textu',
    hidden: search_hidden,
    ajax: true
}) }}

{% set tab_params = {} %}
{% if search is not empty %}
    {% set tab_params = tab_params|merge({ q: search }) %}
{% endif %}

{% set tabs = [
    { status: 'published', label: 'Publikované', count: counts.published|default(0) },
    { status: 'draft', label: 'Koncepty', count: counts.draft|default(0) },
    { status: 'trash', label: 'Koš', count: counts.trash|default(0) },
    { label: 'Vše', count: counts.all|default(0), is_default: true }
] %}

{{ ui.status_tabs('/admin/content/' ~ current_type.slug, tabs, current_status, tab_params) }}

{% if items is empty %}
    <div class="alert alert-info">
        {% if current_status == 'published' %}
            Zatím zde není žádný publikovaný obsah.
        {% elseif current_status == 'draft' %}
            Zatím zde nejsou žádné koncepty.
        {% elseif current_status == 'trash' %}
            Koš je prázdný.
        {% else %}
            Zatím zde není žádný obsah.
        {% endif %}
    </div>
{% else %}
    <div class="table-responsive">
        <table class="table align-middle">
            <thead>
                <tr>
                    <th>Název</th>
                    <th>Upraveno</th>
                    <th class="text-end">Akce</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                    <tr>
                        <td class="fw-semibold">
                            {# Stav + Titulek #}
                            <div class="d-flex align-items-center gap-2">
                                {% if item.status == 'published' %}
                                    <i class="bi bi-check-circle-fill text-success" aria-hidden="true"></i>
                                    <span class="visually-hidden">Publikovaný obsah</span>
                                {% else %}
                                    <i class="bi bi-pencil-fill text-secondary" aria-hidden="true"></i>
                                    <span class="visually-hidden">Koncept</span>
                                {% endif %}
                                <span>{{ item.title }}</span>
                            </div>

                            {# Slug pod tím #}
                            <div class="small text-muted mt-1">
                                <code>{{ item.slug }}</code>
                            </div>
                        </td>

                        <td>    {% if item.updated_at is not empty %}
        {{ item.updated_at|date(df ~ ' ' ~ tf) }}
    {% endif %}</td>

        <td class="text-end">
            {% set deleteConfirm = current_status == 'trash'
                ? 'Opravdu nenávratně smazat tento obsah?'
                : 'Přesunout obsah do koše?'
            %}

            {% set extraActions = [] %}
            {% if current_status == 'trash' %}
                {% set extraActions = extraActions|merge([{
                    type: 'form',
                    action: '/admin/content/' ~ current_type.slug ~ '/' ~ item.id ~ '/restore',
                    variant: 'success',
                    icon: 'bi-arrow-counterclockwise',
                    ajax: true,
                    hidden: { redirect: pagination.current_url },
                    confirm: 'Obnovit tento obsah?'
                }]) %}
            {% endif %}

            {{ ui.crud_actions('/admin/content/' ~ current_type.slug ~ '/' ~ item.id, {
                edit: current_status == 'trash' ? false : {},
                delete: {
                    confirm: deleteConfirm,
                    ajax: true,
                    hidden: { redirect: pagination.current_url },
                    variant: 'danger',
                    icon: current_status == 'trash' ? 'bi-trash3' : 'bi-trash'
                },
                extra: extraActions
            }) }}
        </td>
    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {{ ui.pagination(pagination) }}
{% endif %}
