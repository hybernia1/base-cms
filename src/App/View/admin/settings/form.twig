{% extends 'admin/layout.twig' %}

{% set active_section = active_section|default('main') %}
{% set current_menu = 'settings:' ~ active_section %}
{% block title %}Nastavení | Administrace{% endblock %}

{% block body %}
    <h1 class="h4 mb-3">Nastavení</h1>

    <div class="row">
        <div class="col-12">
            <form method="post" action="/admin/settings/{{ active_section }}" class="card shadow-sm" id="settingsForm">
                <div class="card-body p-4">
                    {% if active_section == 'main' %}
                        <h2 class="h5 mb-3">Základní nastavení</h2>
                        <div class="mb-3">
                            <label for="site_name" class="form-label">Název webu</label>
                            <input type="text" name="site_name" id="site_name" value="{{ values.site_name }}" class="form-control" required>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="allow_registration" name="allow_registration" value="1" {% if values.allow_registration == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="allow_registration">Povolit frontend registrace</label>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="timezone" class="form-label">Časové pásmo</label>
                                <select id="timezone" name="timezone" class="form-select">
                                    {% set currentTz = values.timezone|default(app_settings.timezone) %}
                                    {% for tz in timezones %}
                                        <option value="{{ tz }}" {% if tz == currentTz %}selected{% endif %}>{{ tz }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="date_format" class="form-label">Formát data</label>
                                <select id="date_format" name="date_format" class="form-select">
                                    {% set currentDateFormat = values.date_format|default(app_settings.date_format) %}
                                    {% for format in date_formats %}
                                        <option value="{{ format }}" {% if format == currentDateFormat %}selected{% endif %}>{{ "now"|date(format) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="time_format" class="form-label">Formát času</label>
                                <select id="time_format" name="time_format" class="form-select">
                                    {% set currentTimeFormat = values.time_format|default(app_settings.time_format) %}
                                    {% for format in time_formats %}
                                        <option value="{{ format }}" {% if format == currentTimeFormat %}selected{% endif %}>{{ "now"|date(format) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                    {% elseif active_section == 'uploads' %}
                        <h2 class="h5 mb-3">Uploady</h2>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="allow_webp" name="allow_webp" value="1" {% if values.allow_webp == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="allow_webp">Povolit generování WebP variant</label>
                        </div>

                        <div class="mb-3">
                            <label for="allowed_upload_types" class="form-label">Povolené přípony uploadů</label>
                            <input type="text" name="allowed_upload_types" id="allowed_upload_types" value="{{ values.allowed_upload_types }}" class="form-control">
                            <div class="form-text">Zadejte seznam přípon oddělených čárkou (např. jpg,jpeg,png,gif,webp,pdf,zip).</div>
                        </div>

                    {% elseif active_section == 'email' %}
                        <h2 class="h5 mb-3">E-mailové nastavení</h2>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="smtp_host" class="form-label">SMTP server</label>
                                <input type="text" class="form-control" id="smtp_host" name="smtp_host" value="{{ values.smtp_host }}" placeholder="smtp.example.com">
                            </div>
                            <div class="col-md-3">
                                <label for="smtp_port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="smtp_port" name="smtp_port" value="{{ values.smtp_port|default(587) }}" min="1">
                            </div>
                            <div class="col-md-3">
                                <label for="smtp_encryption" class="form-label">Zabezpečení</label>
                                <select id="smtp_encryption" name="smtp_encryption" class="form-select">
                                    {% set encryption = values.smtp_encryption|default('tls') %}
                                    <option value="" {% if encryption == '' %}selected{% endif %}>Bez šifrování</option>
                                    <option value="tls" {% if encryption == 'tls' %}selected{% endif %}>TLS</option>
                                    <option value="ssl" {% if encryption == 'ssl' %}selected{% endif %}>SSL</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="smtp_username" class="form-label">Uživatelské jméno</label>
                                <input type="text" class="form-control" id="smtp_username" name="smtp_username" value="{{ values.smtp_username }}">
                            </div>
                            <div class="col-md-6">
                                <label for="smtp_password" class="form-label">Heslo</label>
                                <input type="password" class="form-control" id="smtp_password" name="smtp_password" value="{{ values.smtp_password }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="smtp_from_email" class="form-label">Odesílatel (e-mail)</label>
                                <input type="email" class="form-control" id="smtp_from_email" name="smtp_from_email" value="{{ values.smtp_from_email }}" placeholder="noreply@example.com">
                            </div>
                            <div class="col-md-6">
                                <label for="smtp_from_name" class="form-label">Odesílatel (jméno)</label>
                                <input type="text" class="form-control" id="smtp_from_name" name="smtp_from_name" value="{{ values.smtp_from_name }}" placeholder="Moje CMS">
                            </div>
                        </div>

                    {% elseif active_section == 'comments' %}
                        <h2 class="h5 mb-3">Komentáře</h2>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="comments_enabled" name="comments_enabled" value="1" {% if values.comments_enabled == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="comments_enabled">Povolit komentáře globálně</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="comments_allow_replies" name="comments_allow_replies" value="1" {% if values.comments_allow_replies == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="comments_allow_replies">Povolit odpovědi na komentáře</label>
                        </div>

                        <div class="mb-3">
                            <label for="comments_max_depth" class="form-label">Maximální úroveň vláken</label>
                            <input type="number" class="form-control" id="comments_max_depth" name="comments_max_depth" value="{{ values.comments_max_depth|default(2) }}" min="0" max="5">
                            <div class="form-text">0 = zakáže odpovědi, 1 = pouze hlavní komentáře, 5 = hlubší vlákna.</div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="comments_moderation" name="comments_moderation" value="1" {% if values.comments_moderation == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="comments_moderation">Vyžadovat schválení komentářů</label>
                            <div class="form-text">Moderace se uplatní pouze pokud jsou povoleny anonymní komentáře. Přihlášení uživatelé publikují ihned.</div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="comments_allow_anonymous" name="comments_allow_anonymous" value="1" {% if values.comments_allow_anonymous == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="comments_allow_anonymous">Povolit komentáře anonymním uživatelům</label>
                            <div class="form-text">Při vypnutí tohoto nastavení se komentáře povolí pouze přihlášeným účtům a schvalování se nevyužije.</div>
                        </div>

                    {% elseif active_section == 'security' %}
                        <h2 class="h5 mb-3">Bezpečnost</h2>
                        {% set captchaForms = values.captcha_forms is defined and values.captcha_forms ? values.captcha_forms|json_decode : [] %}

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="captcha_enabled" name="captcha_enabled" value="1" {% if values.captcha_enabled == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="captcha_enabled">Povolit ochranu pomocí Captcha</label>
                            <div class="form-text">Používá knihovnu Gregwar/Captcha.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Kde zobrazit Captcha</label>
                            <div class="form-text mb-2">Zvolte formuláře, ve kterých se má ochrana objevit.</div>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="captcha_form_register" name="captcha_forms[]" value="register" {% if 'register' in captchaForms %}checked{% endif %}>
                                        <label class="form-check-label" for="captcha_form_register">Registrace</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="captcha_form_login" name="captcha_forms[]" value="login" {% if 'login' in captchaForms %}checked{% endif %}>
                                        <label class="form-check-label" for="captcha_form_login">Přihlášení</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="captcha_form_comments" name="captcha_forms[]" value="comments" {% if 'comments' in captchaForms %}checked{% endif %}>
                                        <label class="form-check-label" for="captcha_form_comments">Komentáře (anonymní)</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label" for="captcha_length">Počet znaků</label>
                                <input type="number" class="form-control" id="captcha_length" name="captcha_length" value="{{ values.captcha_length|default(5) }}" min="3" max="8">
                                <div class="form-text">Doporučeno 4–6 znaků.</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" for="captcha_width">Šířka obrázku</label>
                                <input type="number" class="form-control" id="captcha_width" name="captcha_width" value="{{ values.captcha_width|default(180) }}" min="80" max="400">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" for="captcha_height">Výška obrázku</label>
                                <input type="number" class="form-control" id="captcha_height" name="captcha_height" value="{{ values.captcha_height|default(50) }}" min="30" max="200">
                            </div>
                        </div>

                    {% elseif active_section == 'content-types' %}
                        <h2 class="h5 mb-3">Typy obsahu</h2>

                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <p class="mb-0 flex-grow-1">
                                Definujte typy obsahu podobně jako ve WordPressu. Každý typ musí mít klíč (používá se v databázi) a slug (pro URL v administraci).
                            </p>
                            <button type="button" class="btn btn-outline-primary ms-auto" id="addContentType">
                                Přidat typ
                            </button>
                        </div>

                        {% set types = content_types is defined and content_types ? content_types : [] %}
                        {% if types is empty %}
                            {% set types = [
                                { key: 'post', name: 'Příspěvek', plural_name: 'Příspěvky', slug: 'prispevky', menu_label: 'Příspěvky' },
                                { key: 'page', name: 'Stránka', plural_name: 'Stránky', slug: 'stranky', menu_label: 'Stránky' }
                            ] %}
                        {% endif %}

                        <div id="contentTypesList" class="row gy-3">
                            {% for type in types %}
                                <div class="col-12">
                                    <div class="border rounded p-3 bg-light h-100">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="fw-semibold">
                                                {{ type.name }} ({{ type.key }})
                                            </span>
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-content-type">
                                                Smazat
                                            </button>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <label class="form-label">Klíč</label>
                                                <input type="text" name="content_types[key][]" class="form-control" value="{{ type.key }}" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Název</label>
                                                <input type="text" name="content_types[name][]" class="form-control" value="{{ type.name }}" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Plurál</label>
                                                <input type="text" name="content_types[plural_name][]" class="form-control" value="{{ type.plural_name|default(type.name ~ 'y') }}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Slug</label>
                                                <input type="text" name="content_types[slug][]" class="form-control" value="{{ type.slug }}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Název v menu</label>
                                                <input type="text" name="content_types[menu_label][]" class="form-control" value="{{ type.menu_label|default(type.plural_name) }}" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                    {% elseif active_section == 'term-types' %}
                        <h2 class="h5 mb-3">Typy termů</h2>

                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <p class="mb-0 flex-grow-1">
                                Stejně jako u typů obsahu si můžete definovat vlastní typy termů (tagy, kategorie...).
                            </p>
                            <button type="button" class="btn btn-outline-primary ms-auto" id="addTermType">
                                Přidat typ termu
                            </button>
                        </div>

                        {% set termTypes = term_types is defined and term_types ? term_types : [] %}
                        {% if termTypes is empty %}
                            {% set termTypes = [
                                { key: 'tag', label: 'Tag', content_types: [] },
                                { key: 'category', label: 'Kategorie', content_types: [] }
                            ] %}
                        {% endif %}

                        <div id="termTypesList" class="row gy-3">
                            {% for type in termTypes %}
                                <div class="col-12">
                                    <div class="border rounded p-3 bg-light h-100">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="fw-semibold">
                                                {{ type.label }} ({{ type.key }})
                                            </span>
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-term-type">
                                                Smazat
                                            </button>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <label class="form-label">Klíč</label>
                                                <input type="text" name="term_types[key][{{ loop.index0 }}]" class="form-control" value="{{ type.key }}" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Název</label>
                                                <input type="text" name="term_types[label][{{ loop.index0 }}]" class="form-control" value="{{ type.label }}" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Typy obsahu</label>
                                                <select name="term_types[content_types][{{ loop.index0 }}][]" class="form-select" multiple>
                                                    {% set allowed = type.content_types is defined and type.content_types is iterable ? type.content_types : [] %}
                                                    {% for key, contentType in content_types %}
                                                        <option value="{{ key }}" {% if key in allowed %}selected{% endif %}>{{ contentType.name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <div class="form-text">Nevybráno = dostupné všude.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="card-footer bg-light d-flex justify-content-between align-items-center">
                    <a href="/admin" class="btn btn-outline-secondary">Zpět</a>
                    <button class="btn btn-primary" type="submit">Uložit</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        (function () {
            // ---------- Typy obsahu ----------
            const contentTypesList = document.getElementById('contentTypesList');
            const addContentTypeButton = document.getElementById('addContentType');

            if (addContentTypeButton && contentTypesList) {
                addContentTypeButton.addEventListener('click', function () {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'col-12';
                    wrapper.innerHTML = `
                        <div class="border rounded p-3 bg-light h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">
                                    Nový typ
                                </span>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-content-type">
                                    Smazat
                                </button>
                            </div>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label">Klíč</label>
                                    <input type="text" name="content_types[key][]" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Název</label>
                                    <input type="text" name="content_types[name][]" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Plurál</label>
                                    <input type="text" name="content_types[plural_name][]" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Slug</label>
                                    <input type="text" name="content_types[slug][]" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Název v menu</label>
                                    <input type="text" name="content_types[menu_label][]" class="form-control" required>
                                </div>
                            </div>
                        </div>
                    `;
                    contentTypesList.appendChild(wrapper);
                });

                contentTypesList.addEventListener('click', function (event) {
                    if (!(event.target instanceof HTMLElement)) return;
                    if (event.target.classList.contains('remove-content-type')) {
                        const col = event.target.closest('.col-12');
                        if (col) {
                            col.parentNode.removeChild(col);
                        }
                    }
                });
            }

            // ---------- Typy termů ----------
            const termTypesList = document.getElementById('termTypesList');
            const addTermTypeButton = document.getElementById('addTermType');
            let termTypeIndex = termTypesList ? termTypesList.querySelectorAll('.col-12').length : 0;
            const termTypeContentOptions = `{% for key, contentType in content_types %}<option value="{{ key }}">{{ contentType.name }}</option>{% endfor %}`;

            if (addTermTypeButton && termTypesList) {
                addTermTypeButton.addEventListener('click', function () {
                    const currentIndex = termTypeIndex++;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'col-12';
                    wrapper.innerHTML = `
                        <div class="border rounded p-3 bg-light h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">
                                    Nový term
                                </span>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-term-type">
                                    Smazat
                                </button>
                            </div>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label">Klíč</label>
                                    <input type="text" name="term_types[key][${currentIndex}]" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Název</label>
                                    <input type="text" name="term_types[label][${currentIndex}]" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Typy obsahu</label>
                                    <select name="term_types[content_types][${currentIndex}][]" class="form-select" multiple>
                                        ${termTypeContentOptions}
                                    </select>
                                    <div class="form-text">Nevybráno = dostupné všude.</div>
                                </div>
                            </div>
                        </div>
                    `;
                    termTypesList.appendChild(wrapper);
                });

                termTypesList.addEventListener('click', function (event) {
                    if (!(event.target instanceof HTMLElement)) return;
                    if (event.target.classList.contains('remove-term-type')) {
                        const col = event.target.closest('.col-12');
                        if (col) {
                            col.parentNode.removeChild(col);
                        }
                    }
                });
            }
        })();
    </script>
{% endblock %}
