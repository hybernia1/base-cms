{% extends 'front/layout.twig' %}

{% set breadcrumbs_enabled = false %}
{% set can_manage_comments = can_manage_comments is defined ? can_manage_comments : (current_user and current_user.role == 'admin') %}

{% block head_extra %}
    {{ parent() }}
    <style>
        .comment-replies {
            margin-left: 0;
            padding-left: 0;
        }

        .comment-reply-list {
            display: flex;
            flex-direction: column;
            row-gap: calc(var(--comment-gap) * 0.75);
            margin-top: .35rem;
        }

        .comment-thread-item {
            display: flex;
            flex-direction: column;
            row-gap: .65rem;
        }

        .comment-thread-item + .comment-thread-item {
            margin-top: var(--comment-gap);
        }

        .comment-replies.is-thread-root .comment-reply-list {
            margin-top: .5rem;
        }

        .reply-toggle {
            font-weight: 600;
            color: var(--accent);
        }

        .reply-toggle:hover,
        .reply-toggle:focus {
            color: #365fa5;
            text-decoration: none;
        }

        .comment-text .comment-mention {
            font-weight: 600;
            color: var(--accent);
            text-decoration: none;
        }

        .comment-text .comment-mention:hover,
        .comment-text .comment-mention:focus {
            color: #365fa5;
            text-decoration: underline;
        }

        .comment-mention-preview {
            border-left: 3px solid var(--bs-border-color);
            padding-left: .5rem;
            margin-top: .35rem;
            color: var(--bs-body-color);
            font-size: .9rem;
        }

        .comment-mention-body {
            margin-top: .35rem;
        }

        .comment-header {
            display: flex;
            align-items: flex-start;
            gap: .5rem;
            width: 100%;
            flex-wrap: nowrap;
        }

        .comment-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: .35rem;
            flex-shrink: 0;
        }

        .comment-action-btn {
            border: none;
            background-color: transparent;
            box-shadow: none;
            padding: .2rem .35rem;
            color: var(--bs-secondary-color);
            line-height: 1;
        }

        .comment-action-btn:hover,
        .comment-action-btn:focus {
            background-color: transparent;
            color: var(--bs-body-color);
            box-shadow: none;
        }

        .comment-action-btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .reply-button {
            border: none;
            background-color: transparent;
            box-shadow: none;
            color: var(--accent);
        }

        .reply-button:hover,
        .reply-button:focus {
            background-color: transparent;
            color: #365fa5;
            box-shadow: none;
        }

        .reply-button:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        @media (max-width: 767.98px) {
            .comment-thread {
                --comment-gap: .75rem;
                --comment-indent-size: 32px;
                --comment-padding-y: .45rem;
            }

            .comment-card {
                padding: .65rem .75rem;
                border-radius: 12px;
            }

            .comment-inner {
                align-items: flex-start;
                gap: .5rem;
            }

            .comment-footer {
                align-items: flex-start !important;
                flex-direction: column;
                row-gap: .35rem;
            }

            .comment-footer .btn {
                padding-inline: .75rem;
            }

            .comment-text {
                line-height: 1.45;
                font-size: .93rem;
            }

            .comment-header {
                flex-wrap: wrap;
            }

            .comment-body {
                font-size: .93rem;
            }

            .comment-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>
{% endblock %}

{% block title %}
    Diskuse k článku: {{ content.title }} | {{ type.name|default('Obsah') }}
{% endblock %}

{% block body %}
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="d-flex align-items-center gap-3 mt-4 flex-wrap">
                <div>
                    <h1 class="h4 mb-0">Diskuse k článku: <a href="{{ content_url }}" class=""> {{ content.title }}</a></h1>
                </div>
            </div>

            {% set perex = content.excerpt ?: (content.body|default('')|striptags|slice(0, 240)) %}
            {% if perex or thumbnail %}
                <div class="d-flex align-items-start gap-3 mt-3">
                    {% if perex %}
                        <p class="mb-0 text-muted">{{ perex }}</p>
                    {% endif %}
                </div>
            {% endif %}

            {% if comment_allowed %}
                <section class="mt-3">
                    <div id="commentFormHome">
                        <div id="commentFormWrapper">
                            <form method="post" action="/comments" class="mt-3" id="commentForm">
                                <input type="hidden" name="content_id" value="{{ content.id }}">
                                <input type="hidden" name="parent_id" value="">
                                <input type="hidden" name="reply_depth" value="">
                                <input type="hidden" name="mention_only" value="0">
                                <input type="hidden" name="_csrf" value="{{ csrf_token('comment_form') }}">

                                <div id="replyInfo" class="alert alert-secondary d-none py-2 px-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="small"><span data-reply-label>Odpovídáte na</span> <strong id="replyTarget"></strong></div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="cancelReply">Zrušit</button>
                                    </div>
                                </div>

                                <div id="editInfo" class="alert alert-warning d-none py-2 px-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="small">Upravujete komentář <strong id="editTarget"></strong></div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="cancelEdit">Zrušit úpravu</button>
                                    </div>
                                </div>

                                {# ZMĚNĚNÝ LABEL PODLE PŘIHLÁŠENÍ #}
                                <div class="mb-3">
                                    <label for="comment_body" class="form-label">
                                        {% if current_user %}
                                            {{ current_user.nickname is not empty ? current_user.nickname : current_user.email }}
                                        {% else %}
                                            Komentář
                                        {% endif %}
                                    </label>
                                    <textarea class="form-control" id="comment_body" name="body" rows="4" required {% if not commenting_enabled %}disabled{% endif %}></textarea>
                                </div>

                                {# BLOK S "PŘIHLÁŠEN JAKO..." JE PRYČ #}
                                {% if (not current_user) and comment_settings.allow_anonymous %}
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="comment_author" class="form-label">Jméno</label>
                                            <input type="text" class="form-control" id="comment_author" name="author_name" value="" required {% if not commenting_enabled %}disabled{% endif %}>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="comment_email" class="form-label">E-mail</label>
                                            <input type="email" class="form-control" id="comment_email" name="author_email" value="" required {% if not commenting_enabled %}disabled{% endif %}>
                                        </div>
                                    </div>
                                {% endif %}

                                {% if not commenting_enabled %}
                                    <div class="alert alert-info mt-3">Komentáře jsou povoleny pouze pro přihlášené uživatele.</div>
                                {% endif %}

                                <div id="commentAlert" class="alert d-none mt-3" role="alert"></div>

                                <button type="submit" class="btn btn-primary mt-3" {% if not commenting_enabled %}disabled{% endif %}>Odeslat</button>
                            </form>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                        <h2 class="h5 mb-0">Diskuse(<span data-comment-count>{{ comments|length }}</span>)</h2>
                    </div>

                    <div class="comment-thread" role="list" data-comment-thread>
                        {% if comments %}
                            {% for comment in comments %}
                                {% set has_parent = comment.depth > 0 %}
                                {% set is_mention_only = comment.mention_only ?? false %}
                                {% set base_indent = comment_settings.max_depth is defined ? min(comment.depth, comment_settings.max_depth) : comment.depth %}
                                {% set indent_depth = base_indent %}
                                <article class="comment-item{% if has_parent %} has-parent{% endif %}{% if comment.depth == 0 %} is-root{% endif %}" id="comment-{{ comment.id }}" data-depth="{{ comment.depth }}" data-comment-id="{{ comment.id }}" data-comment-body="{{ comment.body|e('html_attr') }}" data-mention-only="{{ is_mention_only ? '1' : '0' }}" data-comment-url="{{ comment.comment_url|default('') }}" style="--comment-indent: {{ indent_depth }}" role="listitem">
                                    <div class="comment-card">
                                        <div class="comment-inner">
                                            <div class="comment-avatar">
                                                <span class="avatar avatar-sm bg-primary-subtle text-primary fw-bold flex-shrink-0">
                                                    {% if comment.avatar.url %}
                                                        <img src="{{ comment.avatar.url }}" alt="Avatar {{ comment.author_name ?: 'Anonym' }}" class="rounded-circle" loading="lazy">
                                                    {% else %}
                                                        {{ comment.avatar.initials }}
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="comment-body container">
                                                <div class="comment-header">
                                                    <div class="flex-grow-1 min-w-0">
                                                        <div class="fw-semibold">
                                                            {% if comment.profile_url %}
                                                                <a href="{{ comment.profile_url }}" class="text-decoration-none">{{ comment.author_name ?: 'Anonym' }}</a>
                                                            {% else %}
                                                                {{ comment.author_name ?: 'Anonym' }}
                                                            {% endif %}
                                                        </div>
                                                        <div class="text-muted small d-flex align-items-center gap-1">
                                                            <i class="bi bi-clock" aria-hidden="true"></i>
                                                            <span>{{ comment.created_at|date('j. n. Y H:i') }}</span>
                                                        </div>
                                                    </div>
                                                    {% if can_manage_comments %}
                                                        <div class="comment-actions">
                                                            <button type="button" class="btn btn-sm comment-action-btn edit-comment" data-comment-id="{{ comment.id }}" data-comment-body="{{ comment.body|e('html_attr') }}" aria-label="Upravit komentář {{ comment.id }}">
                                                                <i class="bi bi-pencil" aria-hidden="true"></i>
                                                                <span class="visually-hidden">Upravit komentář</span>
                                                            </button>
                                                            <button type="button" class="btn btn-sm comment-action-btn delete-comment" data-comment-id="{{ comment.id }}" aria-label="Smazat komentář {{ comment.id }}">
                                                                <i class="bi bi-trash" aria-hidden="true"></i>
                                                                <span class="visually-hidden">Smazat komentář</span>
                                                            </button>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="mt-2 comment-text">{{ comment.body|nl2br }}</div>
                                                {% set can_thread_reply = comment_settings.allow_replies and comment_settings.max_depth > comment.depth and commenting_enabled %}
                                                {% set can_mention = comment_settings.allow_replies and comment_settings.max_depth > 0 and comment_settings.max_depth <= comment.depth and commenting_enabled %}
                                                {% if (can_thread_reply or can_mention) %}
                                                    <div class="comment-footer d-flex align-items-center gap-2 flex-wrap">
                                                        <div class="d-flex gap-2 flex-wrap" data-reply-actions>
                                                            {% if can_thread_reply or can_mention %}
                                                                <button
                                                                    type="button"
                                                                    class="btn btn-sm reply-button"
                                                                    data-reply-id="{{ comment.id }}"
                                                                    data-reply-author="{{ comment.author_name ?: 'Anonym' }}"
                                                                    data-mention-only="{{ can_mention and not can_thread_reply ? '1' : '0' }}"
                                                                    data-reply-depth="{{ comment.depth }}"
                                                                    aria-label="Reagovat na {{ comment.author_name ?: 'Anonym' }}"
                                                                >
                                                                    <i class="bi bi-reply me-1"></i>
                                                                    <span class="d-none d-sm-inline">Reagovat</span>
                                                                    <span class="visually-hidden d-sm-none">Reagovat</span>
                                                                    {% if can_mention and not can_thread_reply %}
                                                                        <span class="visually-hidden">(zmínka)</span>
                                                                    {% endif %}
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </article>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <p class="text-muted mb-0{% if comments %} d-none{% endif %}" data-empty-comments>Buďte první, kdo přidá komentář.</p>
                </section>
            {% else %}
                <div class="alert alert-info mt-4">Diskuse u tohoto obsahu je uzavřena.</div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ parent() }}
    {% if comment_allowed %}
        <script>
            (function() {
                const form = document.getElementById('commentForm');
                if (!form) return;

                const parentField = form.querySelector('input[name="parent_id"]');
                const replyInfo = document.getElementById('replyInfo');
                const replyTarget = document.getElementById('replyTarget');
                const replyLabel = replyInfo ? replyInfo.querySelector('[data-reply-label]') : null;
                const cancelReply = document.getElementById('cancelReply');
                const editInfo = document.getElementById('editInfo');
                const editTarget = document.getElementById('editTarget');
                const cancelEdit = document.getElementById('cancelEdit');
                const mentionField = form.querySelector('input[name="mention_only"]');
                const replyDepthField = form.querySelector('input[name="reply_depth"]');
                const formWrapper = document.getElementById('commentFormWrapper');
                const formHome = document.getElementById('commentFormHome');

                const commentBody = document.getElementById('comment_body');
                const alertBox = document.getElementById('commentAlert');
                let isMentionOnly = false;
                let mentionPrefix = '';
                let editingCommentId = null;

                const commentThread = document.querySelector('[data-comment-thread]');
                const emptyState = document.querySelector('[data-empty-comments]');
                const commentCount = document.querySelector('[data-comment-count]');
                const commentSettings = {{ comment_settings|json_encode|raw }};
                const commentingEnabled = {{ commenting_enabled ? 'true' : 'false' }};
                const canManageComments = {{ can_manage_comments ? 'true' : 'false' }};
                const adminCsrfToken = '{{ csrf_token('comment_admin') }}';
                const contentId = {{ content.id }};
                const initialComments = {{ comments|json_encode|raw }};
                const commentMap = new Map();
                const expandedThreadIds = new Set();

                const escapeHtml = (value) => {
                    return value
                        ? value.replace(/[&<>'"]/g, (char) => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[char]))
                        : '';
                };

                const nl2br = (text) => escapeHtml(text || '').replace(/\n/g, '<br>');

                const buildCommentIndex = (items = []) => {
                    commentMap.clear();
                    items.forEach((item) => {
                        if (item && item.id !== undefined) {
                            commentMap.set(Number(item.id), item);
                        }
                    });
                };

                const getMentionTarget = (comment) => {
                    if (!comment || !comment.mention_only) {
                        return null;
                    }

                    const parentId = comment.parent_id ? Number(comment.parent_id) : 0;
                    return parentId && commentMap.has(parentId) ? commentMap.get(parentId) : null;
                };

                const formatMentionPreview = (text = '') => {
                    const value = (text || '').trim();
                    if (!value) return '';

                    return value.length > 160 ? `${value.slice(0, 160)}…` : value;
                };

                const updateCount = (count) => {
                    if (commentCount) {
                        commentCount.textContent = count;
                    }
                };

                const toggleEmptyState = (hasComments) => {
                    if (emptyState) {
                        emptyState.classList.toggle('d-none', hasComments);
                    }
                };

                const ensureConfirmModal = () => {
                    let modalEl = document.getElementById('commentConfirmModal');
                    if (modalEl) {
                        return modalEl;
                    }

                    const container = document.createElement('div');
                    container.innerHTML = `
                        <div class="modal fade" id="commentConfirmModal" tabindex="-1" aria-labelledby="commentConfirmTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="commentConfirmTitle" data-confirm-title>Mazání komentáře</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
                                    </div>
                                    <div class="modal-body" data-confirm-message>Opravdu chcete smazat tento komentář?</div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zrušit</button>
                                        <button type="button" class="btn btn-danger" data-confirm-approve>Smazat</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    modalEl = container.firstElementChild;
                    document.body.appendChild(modalEl);
                    return modalEl;
                };

                const confirmDelete = (message = 'Opravdu chcete smazat tento komentář?') => {
                    return new Promise((resolve) => {
                        const modalEl = ensureConfirmModal();
                        const titleEl = modalEl.querySelector('[data-confirm-title]');
                        const messageEl = modalEl.querySelector('[data-confirm-message]');
                        const confirmBtn = modalEl.querySelector('[data-confirm-approve]');

                        if (titleEl) {
                            titleEl.textContent = 'Mazání komentáře';
                        }
                        if (messageEl) {
                            messageEl.textContent = message;
                        }
                        if (confirmBtn) {
                            confirmBtn.textContent = 'Smazat';
                        }

                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                        let resolved = false;

                        const cleanup = () => {
                            if (confirmBtn) {
                                confirmBtn.removeEventListener('click', onConfirm);
                            }
                            modalEl.removeEventListener('hidden.bs.modal', onHide);
                        };

                        const onConfirm = () => {
                            resolved = true;
                            cleanup();
                            modal.hide();
                            resolve(true);
                        };

                        const onHide = () => {
                            if (!resolved) {
                                resolve(false);
                            }
                            cleanup();
                        };

                        modalEl.addEventListener('hidden.bs.modal', onHide);
                        if (confirmBtn) {
                            confirmBtn.addEventListener('click', onConfirm, { once: true });
                        }

                        modal.show();
                    });
                };

                const isFormInteracting = () => {
                    const active = document.activeElement;
                    const isFocused = active && formWrapper && formWrapper.contains(active);
                    const isReplying = formWrapper && formHome && formWrapper.parentElement !== formHome;

                    return Boolean(isFocused || isReplying);
                };

                const moveFormHome = () => {
                    if (formWrapper && formHome && !formHome.contains(formWrapper)) {
                        formHome.appendChild(formWrapper);
                    }
                };

                const resetReply = () => {
                    parentField.value = '';
                    if (mentionField) {
                        mentionField.value = '0';
                    }
                    if (replyDepthField) {
                        replyDepthField.value = '';
                    }
                    if (commentBody && mentionPrefix && commentBody.value.startsWith(mentionPrefix)) {
                        commentBody.value = commentBody.value.slice(mentionPrefix.length);
                    }
                    mentionPrefix = '';
                    isMentionOnly = false;
                    if (replyLabel) {
                        replyLabel.textContent = 'Odpovídáte na';
                    }
                    if (replyTarget) {
                        replyTarget.textContent = '';
                    }
                    if (replyInfo) {
                        replyInfo.classList.add('d-none');
                    }

                    moveFormHome();
                };

                const resetEdit = () => {
                    editingCommentId = null;
                    if (editTarget) {
                        editTarget.textContent = '';
                    }
                    if (editInfo) {
                        editInfo.classList.add('d-none');
                    }
                };

                const startEdit = (commentId, bodyText) => {
                    resetReply();
                    editingCommentId = Number(commentId);

                    if (commentBody) {
                        commentBody.value = bodyText || '';
                        commentBody.focus();
                    }

                    if (editTarget) {
                        editTarget.textContent = `#${commentId}`;
                    }
                    if (editInfo) {
                        editInfo.classList.remove('d-none');
                    }

                    if (formWrapper && commentThread) {
                        const commentItem = commentThread.querySelector(`[data-comment-id="${commentId}"]`);
                        if (commentItem) {
                            commentItem.insertAdjacentElement('afterend', formWrapper);
                        }
                    }
                };

                if (cancelReply) {
                    cancelReply.addEventListener('click', resetReply);
                }

                if (cancelEdit) {
                    cancelEdit.addEventListener('click', () => {
                        resetEdit();
                        resetReply();
                        if (commentBody) {
                            commentBody.value = '';
                        }
                    });
                }

                const handleReplyClick = (btn) => {
                    if (commentBody && mentionPrefix && commentBody.value.startsWith(mentionPrefix)) {
                        commentBody.value = commentBody.value.slice(mentionPrefix.length);
                    }

                    isMentionOnly = btn.dataset.mentionOnly === '1';
                    const replyAuthor = btn.dataset.replyAuthor || 'komentář';
                    parentField.value = btn.dataset.replyId;
                    if (replyDepthField) {
                        replyDepthField.value = btn.dataset.replyDepth || '';
                    }
                    if (mentionField) {
                        mentionField.value = isMentionOnly ? '1' : '0';
                    }

                    mentionPrefix = isMentionOnly && replyAuthor ? `@${replyAuthor} ` : '';
                    if (commentBody && mentionPrefix && !commentBody.value.startsWith(mentionPrefix)) {
                        const existingText = commentBody.value.trim();
                        commentBody.value = existingText ? `${mentionPrefix}${existingText}` : mentionPrefix;
                    }

                    if (replyInfo && replyTarget) {
                        replyTarget.textContent = replyAuthor;
                        if (replyLabel) {
                            replyLabel.textContent = isMentionOnly ? 'Zmiňujete' : 'Odpovídáte na';
                        }
                        replyInfo.classList.remove('d-none');
                    }
                    if (formWrapper && commentThread) {
                        const commentItem = btn.closest('.comment-item');
                        if (commentItem) {
                            commentItem.insertAdjacentElement('afterend', formWrapper);
                        }
                    }

                    if (commentBody) {
                        commentBody.focus();
                    }
                };

                const bindReplyButtons = (scope) => {
                    scope.querySelectorAll('.reply-button').forEach((btn) => {
                        btn.addEventListener('click', () => handleReplyClick(btn));
                    });
                };

                const createActionButtons = (comment) => {
                    const maxDepth = Number(commentSettings.max_depth || 0);
                    const canThreadReply = commentSettings.allow_replies && commentingEnabled && (maxDepth === 0 || maxDepth > comment.depth);
                    const canMention = commentSettings.allow_replies && commentingEnabled && maxDepth > 0 && maxDepth <= comment.depth;
                    const hasReply = canThreadReply || canMention;
                    const hasExistingReplies = comment.depth === 0 && comment.replies && comment.replies.length > 0;

                    if (!hasReply) {
                        return null;
                    }

                    const footer = document.createElement('div');
                    footer.className = 'comment-footer d-flex align-items-center gap-2 flex-wrap';

                    const replyWrap = document.createElement('div');
                    replyWrap.className = 'd-flex gap-2 flex-wrap';
                    replyWrap.dataset.replyActions = 'true';

                    if (hasReply && !hasExistingReplies) {
                        const replyBtn = document.createElement('button');
                        replyBtn.type = 'button';
                        replyBtn.className = 'btn btn-sm btn-outline-primary rounded-pill reply-button';
                        replyBtn.dataset.replyId = comment.id;
                        replyBtn.dataset.replyAuthor = comment.author_name || 'Anonym';
                        replyBtn.dataset.mentionOnly = canMention && !canThreadReply ? '1' : '0';
                        replyBtn.dataset.replyDepth = comment.depth;
                        replyBtn.setAttribute('aria-label', `Odpovědět na ${comment.author_name || 'Anonym'}`);
                        replyBtn.innerHTML = `<i class="bi bi-reply me-1"></i><span>Odpovědět</span>${canMention && !canThreadReply ? '<span class="visually-hidden">(zmínka)</span>' : ''}`;
                        replyWrap.appendChild(replyBtn);
                    }

                    if (replyWrap.childNodes.length || hasExistingReplies) {
                        footer.appendChild(replyWrap);
                    }

                    return footer;
                };

                const createAdminActions = (comment) => {
                    if (!canManageComments) {
                        return null;
                    }

                    const adminWrap = document.createElement('div');
                    adminWrap.className = 'd-flex align-items-start gap-1 ms-auto';

                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'btn btn-sm btn-outline-secondary edit-comment';
                    editBtn.dataset.commentId = comment.id;
                    editBtn.dataset.commentBody = comment.body || '';
                    editBtn.setAttribute('aria-label', `Upravit komentář ${comment.id}`);
                    editBtn.innerHTML = '<i class="bi bi-pencil" aria-hidden="true"></i><span class="visually-hidden">Upravit komentář</span>';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'btn btn-sm btn-outline-danger delete-comment';
                    deleteBtn.dataset.commentId = comment.id;
                    deleteBtn.setAttribute('aria-label', `Smazat komentář ${comment.id}`);
                    deleteBtn.innerHTML = '<i class="bi bi-trash" aria-hidden="true"></i><span class="visually-hidden">Smazat komentář</span>';

                    adminWrap.appendChild(editBtn);
                    adminWrap.appendChild(deleteBtn);

                    return adminWrap;
                };

                const countReplies = (comment) => {
                    if (!comment || !comment.replies) {
                        return 0;
                    }

                    return comment.replies.reduce((total, reply) => total + 1 + countReplies(reply), 0);
                };

                const formatReplyToggleLabel = (count, expanded) => {
                    const icon = '<i class="bi bi-chat-dots me-1" aria-hidden="true"></i>';
                    if (expanded) {
                        return `${icon}<span>Skrýt odpovědi</span>`;
                    }

                    const label = count === 1 ? 'odpověď' : 'odpovědi';
                    return `${icon}<span>Zobrazit ${count} ${label}</span>`;
                };

                const groupCommentsByParent = (items = []) => {
                    const byId = new Map();
                    const roots = [];

                    items.forEach((comment) => {
                        byId.set(comment.id, { ...comment, replies: [] });
                    });

                    byId.forEach((comment) => {
                        const parentId = comment.parent_id ? Number(comment.parent_id) : 0;
                        if (parentId && byId.has(parentId)) {
                            byId.get(parentId).replies.push(comment);
                        } else {
                            roots.push(comment);
                        }
                    });

                    return roots;
                };

                const getExpandedThreadIds = () => {
                    const expanded = new Set();

                    if (!commentThread) {
                        return expanded;
                    }

                    commentThread.querySelectorAll('.comment-replies.is-thread-root .reply-toggle[aria-expanded="true"]').forEach((btn) => {
                        const commentItem = btn.closest('.comment-item');
                        const commentId = commentItem ? commentItem.dataset.commentId : null;

                        if (commentId) {
                            expanded.add(Number(commentId));
                        }
                    });

                    return expanded;
                };

                const renderReplies = (comment, isRootThread = false, expandedThreads = new Set(), replyActionsContainer = null) => {
                    if (!comment.replies || !comment.replies.length) {
                        return null;
                    }

                    const repliesWrapper = document.createElement('div');
                    repliesWrapper.className = 'comment-replies';
                    repliesWrapper.classList.toggle('is-thread-root', isRootThread);

                    const repliesList = document.createElement('div');
                    repliesList.className = 'comment-reply-list';
                    if (isRootThread) {
                        repliesList.classList.add('d-none');
                    }
                    comment.replies.forEach((reply) => {
                        const replyElement = buildCommentElement(reply, true);
                        repliesList.appendChild(replyElement);
                        const nested = renderReplies(reply, false, expandedThreads, replyElement.querySelector('[data-reply-actions]'));
                        if (nested) {
                            repliesList.appendChild(nested);
                        }
                    });

                    const replyCount = countReplies(comment);

                    if (isRootThread) {
                        const toggleBtn = document.createElement('button');
                        toggleBtn.type = 'button';
                        toggleBtn.className = 'btn btn-link text-decoration-none px-0 reply-toggle';
                        toggleBtn.setAttribute('aria-expanded', 'false');
                        toggleBtn.innerHTML = formatReplyToggleLabel(replyCount, false);

                        toggleBtn.addEventListener('click', () => {
                            repliesList.classList.toggle('d-none');
                            const expanded = !repliesList.classList.contains('d-none');
                            toggleBtn.innerHTML = formatReplyToggleLabel(replyCount, expanded);
                            toggleBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                            const commentId = Number(comment.id);
                            if (expanded) {
                                expandedThreadIds.add(commentId);
                            } else {
                                expandedThreadIds.delete(commentId);
                            }
                        });

                        if (expandedThreads.has(comment.id)) {
                            repliesList.classList.remove('d-none');
                            toggleBtn.innerHTML = formatReplyToggleLabel(replyCount, true);
                            toggleBtn.setAttribute('aria-expanded', 'true');
                        }

                        if (replyActionsContainer) {
                            replyActionsContainer.appendChild(toggleBtn);
                        } else {
                            repliesWrapper.appendChild(toggleBtn);
                        }
                    }
                    repliesWrapper.appendChild(repliesList);

                    return repliesWrapper;
                };

                const buildCommentElement = (comment, isReply = false) => {
                    const article = document.createElement('article');
                    const hasParent = comment.depth > 0;
                    const maxDepth = Number(commentSettings.max_depth || 0);
                    const baseDepth = maxDepth > 0 ? Math.min(comment.depth, maxDepth) : comment.depth;
                    const indentDepth = baseDepth;
                    article.className = `comment-item${hasParent ? ' has-parent' : ''}${comment.depth === 0 ? ' is-root' : ''}${isReply ? ' is-reply' : ''}`;
                    article.id = `comment-${comment.id}`;
                    article.dataset.depth = comment.depth;
                    article.dataset.commentId = comment.id;
                    article.dataset.commentBody = comment.body || '';
                    article.dataset.parentId = comment.parent_id || '';
                    article.dataset.mentionOnly = comment.mention_only ? '1' : '0';
                    article.dataset.commentUrl = comment.comment_url || '';
                    article.style.setProperty('--comment-indent', indentDepth);
                    article.setAttribute('role', 'listitem');

                    const card = document.createElement('div');
                    card.className = 'comment-card';
                    const inner = document.createElement('div');
                    inner.className = 'comment-inner';

                    const avatarWrap = document.createElement('div');
                    avatarWrap.className = 'comment-avatar';
                    const avatarSpan = document.createElement('span');
                    avatarSpan.className = 'avatar avatar-sm bg-primary-subtle text-primary fw-bold flex-shrink-0';

                    if (comment.avatar && comment.avatar.url) {
                        const img = document.createElement('img');
                        img.src = comment.avatar.url;
                        img.alt = `Avatar ${comment.author_name || 'Anonym'}`;
                        img.loading = 'lazy';
                        img.className = 'rounded-circle';
                        avatarSpan.appendChild(img);
                    } else {
                        avatarSpan.textContent = (comment.avatar && comment.avatar.initials) ? comment.avatar.initials : '';
                    }

                    avatarWrap.appendChild(avatarSpan);

                    const bodyWrap = document.createElement('div');
                    bodyWrap.className = 'comment-body container';

                    const header = document.createElement('div');
                    header.className = 'd-flex align-items-start gap-2 flex-wrap';

                    const authorBlock = document.createElement('div');
                    authorBlock.className = 'flex-grow-1 min-w-0';
                    const name = document.createElement('div');
                    name.className = 'fw-semibold';
                    if (comment.profile_url) {
                        const link = document.createElement('a');
                        link.href = comment.profile_url;
                        link.className = 'text-decoration-none';
                        link.textContent = comment.author_name || 'Anonym';
                        name.appendChild(link);
                    } else {
                        name.textContent = comment.author_name || 'Anonym';
                    }
                    const meta = document.createElement('div');
                    meta.className = 'text-muted small d-flex align-items-center gap-1';
                    meta.innerHTML = `<i class="bi bi-clock" aria-hidden="true"></i><span>${escapeHtml(comment.created_at_formatted || '')}</span>`;
                    authorBlock.appendChild(name);
                    authorBlock.appendChild(meta);

                    header.appendChild(authorBlock);
                    const adminActions = createAdminActions(comment);
                    if (adminActions) {
                        header.appendChild(adminActions);
                    }

                    const text = document.createElement('div');
                    text.className = 'mt-2 comment-text';
                    const mentionTarget = getMentionTarget(comment);
                    const mentionPreview = mentionTarget
                        ? (() => {
                            const mentionLabel = `@${mentionTarget.author_name || 'Anonym'}`;
                            const previewText = formatMentionPreview(mentionTarget.body || '');
                            let remainingText = (comment.body || '').trimStart();

                            if (remainingText.startsWith(mentionLabel)) {
                                remainingText = remainingText.slice(mentionLabel.length).trimStart();
                            }

                            const previewHtml = previewText
                                ? `<div class="comment-mention-preview">„${escapeHtml(previewText)}“</div>`
                                : '';
                            const remainingHtml = remainingText
                                ? `<div class="comment-mention-body">${nl2br(remainingText)}</div>`
                                : '';

                            return `<a href="#comment-${mentionTarget.id}" class="comment-mention">${escapeHtml(mentionLabel)}</a>${previewHtml}${remainingHtml}`;
                        })()
                        : '';

                    text.innerHTML = mentionPreview || nl2br(comment.body || '');

                    bodyWrap.appendChild(header);
                    bodyWrap.appendChild(text);

                    const footer = createActionButtons(comment);
                    if (footer) {
                        bodyWrap.appendChild(footer);
                    }

                    inner.appendChild(avatarWrap);
                    inner.appendChild(bodyWrap);
                    card.appendChild(inner);
                    article.appendChild(card);

                    return article;
                };

                const bindAdminButtons = (scope) => {
                    if (!canManageComments) return;

                    scope.querySelectorAll('.edit-comment').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const commentId = btn.dataset.commentId;
                            const currentBody = btn.dataset.commentBody || '';
                            startEdit(commentId, currentBody);
                        });
                    });

                    scope.querySelectorAll('.delete-comment').forEach((btn) => {
                        btn.addEventListener('click', async () => {
                            const commentId = btn.dataset.commentId;
                            const confirmed = await confirmDelete('Opravdu chcete smazat tento komentář?');
                            if (!confirmed) return;

                            const formData = new FormData();
                            formData.append('_csrf', adminCsrfToken);

                            try {
                                const response = await fetch(`/comments/${commentId}/delete`, {
                                    method: 'POST',
                                    body: formData,
                                    headers: { 'Accept': 'application/json' },
                                });
                                const data = await response.json();
                                if (alertBox) {
                                    alertBox.textContent = data.message || 'Komentář byl odstraněn.';
                                    alertBox.className = 'alert mt-3 ' + (data.status === 'success' ? 'alert-success' : 'alert-danger');
                                    alertBox.classList.remove('d-none');
                                }
                                if (data.status === 'success') {
                                    await fetchComments();
                                }
                            } catch (error) {
                                if (alertBox) {
                                    alertBox.textContent = 'Smazání komentáře se nezdařilo.';
                                    alertBox.className = 'alert alert-danger mt-3';
                                    alertBox.classList.remove('d-none');
                                }
                            }
                        });
                    });
                };

                const renderComments = (comments = [], { force = false } = {}) => {
                    if (!commentThread) return;
                    if (!force && isFormInteracting()) return;

                    const expandedThreads = new Set(expandedThreadIds);
                    getExpandedThreadIds().forEach((id) => expandedThreads.add(id));
                    expandedThreadIds.clear();
                    expandedThreads.forEach((id) => expandedThreadIds.add(id));

                    moveFormHome();
                    buildCommentIndex(comments);
                    commentThread.innerHTML = '';
                    const fragment = document.createDocumentFragment();
                    const roots = groupCommentsByParent(comments);

                    const visibleThreadIds = new Set();
                    roots.forEach((comment) => {
                        if (comment.replies && comment.replies.length) {
                            visibleThreadIds.add(Number(comment.id));
                        }
                    });

                    expandedThreadIds.forEach((id) => {
                        if (!visibleThreadIds.has(id)) {
                            expandedThreadIds.delete(id);
                        }
                    });

                    roots.forEach((comment) => {
                        const threadItem = document.createElement('div');
                        threadItem.className = 'comment-thread-item';

                        const commentElement = buildCommentElement(comment);
                        threadItem.appendChild(commentElement);

                        const replies = renderReplies(comment, true, expandedThreads, commentElement.querySelector('[data-reply-actions]'));
                        if (replies) {
                            threadItem.appendChild(replies);
                        }

                        fragment.appendChild(threadItem);
                    });

                    commentThread.appendChild(fragment);
                    bindReplyButtons(commentThread);
                    bindAdminButtons(commentThread);
                    toggleEmptyState(comments.length > 0);
                    updateCount(comments.length);
                };

                const fetchComments = async () => {
                    try {
                        const response = await fetch(`/comments?content_id=${contentId}`, {
                            headers: { 'Accept': 'application/json' },
                        });
                        const data = await response.json();
                        if (data.status === 'success') {
                            renderComments(data.comments || [], { force: true });
                        }
                    } catch (error) {
                        // ignore fetch errors
                    }
                };

                bindReplyButtons(document);
                bindAdminButtons(document);
                renderComments(initialComments || []);

                form.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    const bodyValue = commentBody ? commentBody.value.trim() : '';

                    if (!commentBody || bodyValue === '') {
                        if (alertBox) {
                            alertBox.textContent = 'Text komentáře je povinný.';
                            alertBox.className = 'alert alert-danger mt-3';
                            alertBox.classList.remove('d-none');
                        }
                        return;
                    }

                    const isEditing = editingCommentId !== null;
                    const formData = isEditing ? new FormData() : new FormData(form);
                    const requestUrl = isEditing ? `/comments/${editingCommentId}/edit` : '/comments';

                    if (isEditing) {
                        formData.append('body', bodyValue);
                        formData.append('_csrf', adminCsrfToken);
                    } else {
                        formData.set('body', bodyValue);
                        formData.set('parent_id', parentField ? parentField.value : '');
                        formData.set('mention_only', mentionField ? mentionField.value : '0');
                        if (replyDepthField) {
                            formData.set('reply_depth', replyDepthField.value || '');
                        }
                    }

                    try {
                        const response = await fetch(requestUrl, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'Accept': 'application/json',
                            },
                        });

                        const data = await response.json();

                        if (alertBox) {
                            const defaultMessage = isEditing ? 'Komentář byl upraven.' : 'Komentář byl odeslán.';
                            alertBox.textContent = data.message || defaultMessage;
                            alertBox.className = 'alert mt-3 ' + (data.status === 'success' ? 'alert-success' : 'alert-danger');
                            alertBox.classList.remove('d-none');
                        }

                        if (data.status === 'success') {
                            form.reset();
                            resetReply();
                            resetEdit();
                            await fetchComments();
                        }
                    } catch (error) {
                        if (alertBox) {
                            alertBox.textContent = isEditing
                                ? 'Uložení komentáře se nezdařilo.'
                                : 'Odeslání komentáře se nezdařilo. Zkuste to prosím znovu.';
                            alertBox.className = 'alert alert-danger mt-3';
                            alertBox.classList.remove('d-none');
                        }
                    }
                });
            })();
        </script>
    {% endif %}
{% endblock %}
