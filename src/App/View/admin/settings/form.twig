{% extends 'admin/layout.twig' %}

{% set active_section = active_section|default('main') %}
{% set current_menu = 'settings:' ~ active_section %}
{% set sections = settings_sections|default({
    'main': {'label': 'Základní', 'icon': 'bi-gear'},
    'uploads': {'label': 'Uploady', 'icon': 'bi-upload'},
    'email': {'label': 'E-maily', 'icon': 'bi-envelope'},
    'content-types': {'label': 'Typy obsahu', 'icon': 'bi-journal-text'},
    'term-types': {'label': 'Typy termů', 'icon': 'bi-tags'}
}) %}

{% block title %}Nastavení | Administrace{% endblock %}

{% block body %}
    <h1 class="h4 mb-3">Nastavení</h1>

    <div class="row">
        <div class="col-lg-3 border-end mb-3 mb-lg-0">
            <div class="nav flex-lg-column nav-pills gap-2" aria-orientation="vertical">
                {% for key, section in sections %}
                    <a class="nav-link text-start d-flex align-items-center {% if key == active_section %}active{% endif %}" href="/admin/settings/{{ key }}">
                        <i class="bi {{ section.icon|default('bi-gear') }} me-2"></i> {{ section.label|default(key) }}
                    </a>
                {% endfor %}
            </div>
        </div>
        <div class="col-lg-9">
            <form method="post" action="/admin/settings/{{ active_section }}" class="card shadow-sm" id="settingsForm">
                <div class="card-body p-4">
                    {% if active_section == 'main' %}
                        <h2 class="h5 mb-3">Základní nastavení</h2>
                        <div class="mb-3">
                            <label for="site_name" class="form-label">Název webu</label>
                            <input type="text" name="site_name" id="site_name" value="{{ values.site_name }}" class="form-control" required>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="allow_registration" name="allow_registration" value="1" {% if values.allow_registration == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="allow_registration">Povolit frontend registrace</label>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="timezone" class="form-label">Časové pásmo</label>
                                <select id="timezone" name="timezone" class="form-select">
                                    {% set currentTz = values.timezone|default(app_settings.timezone) %}
                                    {% for tz in timezones %}
                                        <option value="{{ tz }}" {% if tz == currentTz %}selected{% endif %}>{{ tz }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="date_format" class="form-label">Formát data</label>
                                <select id="date_format" name="date_format" class="form-select">
                                    {% set currentDateFormat = values.date_format|default(app_settings.date_format) %}
                                    {% for format in date_formats %}
                                        <option value="{{ format }}" {% if format == currentDateFormat %}selected{% endif %}>{{ "now"|date(format) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="time_format" class="form-label">Formát času</label>
                                <select id="time_format" name="time_format" class="form-select">
                                    {% set currentTimeFormat = values.time_format|default(app_settings.time_format) %}
                                    {% for format in time_formats %}
                                        <option value="{{ format }}" {% if format == currentTimeFormat %}selected{% endif %}>{{ "now"|date(format) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    {% elseif active_section == 'uploads' %}
                        <h2 class="h5 mb-3">Uploady</h2>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="allow_webp" name="allow_webp" value="1" {% if values.allow_webp == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="allow_webp">Povolit generování WebP variant</label>
                        </div>

                        <div class="mb-3">
                            <label for="allowed_upload_types" class="form-label">Povolené přípony uploadů</label>
                            <input type="text" name="allowed_upload_types" id="allowed_upload_types" value="{{ values.allowed_upload_types }}" class="form-control">
                            <div class="form-text">Zadejte seznam přípon oddělených čárkou (např. jpg,jpeg,png,gif,webp,pdf,zip).</div>
                        </div>
                    {% elseif active_section == 'email' %}
                        <h2 class="h5 mb-3">E-mailové nastavení</h2>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="smtp_host" class="form-label">SMTP server</label>
                                <input type="text" class="form-control" id="smtp_host" name="smtp_host" value="{{ values.smtp_host }}" placeholder="smtp.example.com">
                            </div>
                            <div class="col-md-3">
                                <label for="smtp_port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="smtp_port" name="smtp_port" value="{{ values.smtp_port|default(587) }}" min="1">
                            </div>
                            <div class="col-md-3">
                                <label for="smtp_encryption" class="form-label">Zabezpečení</label>
                                <select id="smtp_encryption" name="smtp_encryption" class="form-select">
                                    {% set encryption = values.smtp_encryption|default('tls') %}
                                    <option value="" {% if encryption == '' %}selected{% endif %}>Bez šifrování</option>
                                    <option value="tls" {% if encryption == 'tls' %}selected{% endif %}>TLS</option>
                                    <option value="ssl" {% if encryption == 'ssl' %}selected{% endif %}>SSL</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="smtp_username" class="form-label">Uživatelské jméno</label>
                                <input type="text" class="form-control" id="smtp_username" name="smtp_username" value="{{ values.smtp_username }}">
                            </div>
                            <div class="col-md-6">
                                <label for="smtp_password" class="form-label">Heslo</label>
                                <input type="password" class="form-control" id="smtp_password" name="smtp_password" value="{{ values.smtp_password }}">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="smtp_from_email" class="form-label">Odesílatel (e-mail)</label>
                                <input type="email" class="form-control" id="smtp_from_email" name="smtp_from_email" value="{{ values.smtp_from_email }}" placeholder="noreply@example.com">
                            </div>
                            <div class="col-md-6">
                                <label for="smtp_from_name" class="form-label">Odesílatel (jméno)</label>
                                <input type="text" class="form-control" id="smtp_from_name" name="smtp_from_name" value="{{ values.smtp_from_name }}" placeholder="Moje CMS">
                            </div>
                        </div>
                    {% elseif active_section == 'content-types' %}
                        <h2 class="h5 mb-3">Typy obsahu</h2>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <p class="mb-0">Definujte typy obsahu podobně jako ve WordPressu. Každý typ musí mít klíč (používá se v databázi) a slug (pro URL v administraci).</p>
                            <button type="button" class="btn btn-outline-primary" id="addContentType">Přidat typ</button>
                        </div>

                        <div class="table-responsive">
                            <table class="table align-middle" id="contentTypesTable">
                                <thead>
                                    <tr>
                                        <th>Klíč</th>
                                        <th>Název</th>
                                        <th>Plurál</th>
                                        <th>Slug</th>
                                        <th>Název v menu</th>
                                        <th class="text-end">Akce</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set types = content_types is defined and content_types ? content_types : [] %}
                                    {% if types is empty %}
                                        {% set types = [{ key: 'post', name: 'Příspěvek', plural_name: 'Příspěvky', slug: 'prispevky', menu_label: 'Příspěvky' }, { key: 'page', name: 'Stránka', plural_name: 'Stránky', slug: 'stranky', menu_label: 'Stránky' }] %}
                                    {% endif %}
                                    {% for type in types %}
                                        <tr>
                                            <td><input type="text" name="content_types[key][]" class="form-control" value="{{ type.key }}" required></td>
                                            <td><input type="text" name="content_types[name][]" class="form-control" value="{{ type.name }}" required></td>
                                            <td><input type="text" name="content_types[plural_name][]" class="form-control" value="{{ type.plural_name|default(type.name ~ 'y') }}" required></td>
                                            <td><input type="text" name="content_types[slug][]" class="form-control" value="{{ type.slug }}" required></td>
                                            <td><input type="text" name="content_types[menu_label][]" class="form-control" value="{{ type.menu_label|default(type.plural_name) }}" required></td>
                                            <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-row">Smazat</button></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% elseif active_section == 'term-types' %}
                        <h2 class="h5 mb-3">Typy termů</h2>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <p class="mb-0">Stejně jako u typů obsahu si můžete definovat vlastní typy termů (tagy, kategorie...).</p>
                            <button type="button" class="btn btn-outline-primary" id="addTermType">Přidat typ termu</button>
                        </div>

                        <div class="table-responsive">
                            <table class="table align-middle" id="termTypesTable">
                                <thead>
                                      <tr>
                                          <th>Klíč</th>
                                          <th>Název</th>
                                          <th>Typy obsahu</th>
                                          <th class="text-end">Akce</th>
                                      </tr>
                                </thead>
                                <tbody>
                                    {% set termTypes = term_types is defined and term_types ? term_types : [] %}
                                    {% if termTypes is empty %}
                                        {% set termTypes = [{ key: 'tag', label: 'Tag', content_types: [] }, { key: 'category', label: 'Kategorie', content_types: [] }] %}
                                    {% endif %}
                                    {% for type in termTypes %}
                                        <tr>
                                            <td><input type="text" name="term_types[key][{{ loop.index0 }}]" class="form-control" value="{{ type.key }}" required></td>
                                            <td><input type="text" name="term_types[label][{{ loop.index0 }}]" class="form-control" value="{{ type.label }}" required></td>
                                            <td>
                                                <select name="term_types[content_types][{{ loop.index0 }}][]" class="form-select" multiple>
                                                    {% set allowed = type.content_types is defined and type.content_types is iterable ? type.content_types : [] %}
                                                    {% for key, contentType in content_types %}
                                                        <option value="{{ key }}" {% if key in allowed %}selected{% endif %}>{{ contentType.name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <div class="form-text">Nevybráno = dostupné všude.</div>
                                            </td>
                                            <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-row">Smazat</button></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-light d-flex justify-content-between align-items-center">
                    <a href="/admin" class="btn btn-outline-secondary">Zpět</a>
                    <button class="btn btn-primary" type="submit">Uložit</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        (function () {
            const addContentTypeButton = document.getElementById('addContentType');
            if (addContentTypeButton) {
                addContentTypeButton.addEventListener('click', function () {
                    const tbody = document.querySelector('#contentTypesTable tbody');
                    if (!tbody) return;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="text" name="content_types[key][]" class="form-control" required></td>
                        <td><input type="text" name="content_types[name][]" class="form-control" required></td>
                        <td><input type="text" name="content_types[plural_name][]" class="form-control" required></td>
                        <td><input type="text" name="content_types[slug][]" class="form-control" required></td>
                        <td><input type="text" name="content_types[menu_label][]" class="form-control" required></td>
                        <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-row">Smazat</button></td>
                    `;
                    tbody.appendChild(row);
                });

                const contentTypesTable = document.getElementById('contentTypesTable');
                contentTypesTable?.addEventListener('click', function (event) {
                    if (!(event.target instanceof HTMLElement)) return;
                    if (event.target.classList.contains('remove-row')) {
                        const row = event.target.closest('tr');
                        row?.parentNode?.removeChild(row);
                    }
                });
            }

            const termTypeContentOptions = `{% for key, contentType in content_types %}<option value="{{ key }}">{{ contentType.name }}</option>{% endfor %}`;
            let termTypeIndex = document.querySelectorAll('#termTypesTable tbody tr').length;

            const addTermTypeButton = document.getElementById('addTermType');
            if (addTermTypeButton) {
                addTermTypeButton.addEventListener('click', function () {
                    const tbody = document.querySelector('#termTypesTable tbody');
                    if (!tbody) return;

                    const row = document.createElement('tr');
                    const currentIndex = termTypeIndex++;
                    row.innerHTML = `
                        <td><input type="text" name="term_types[key][${currentIndex}]" class="form-control" required></td>
                        <td><input type="text" name="term_types[label][${currentIndex}]" class="form-control" required></td>
                        <td>
                            <select name="term_types[content_types][${currentIndex}][]" class="form-select" multiple>
                                ${termTypeContentOptions}
                            </select>
                            <div class="form-text">Nevybráno = dostupné všude.</div>
                        </td>
                        <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-row">Smazat</button></td>
                    `;
                    tbody.appendChild(row);
                });

                const termTypesTable = document.getElementById('termTypesTable');
                termTypesTable?.addEventListener('click', function (event) {
                    if (!(event.target instanceof HTMLElement)) return;
                    if (event.target.classList.contains('remove-row')) {
                        const row = event.target.closest('tr');
                        row?.parentNode?.removeChild(row);
                    }
                });
            }
        })();
    </script>
{% endblock %}
