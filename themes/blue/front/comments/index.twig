{% extends 'front/layout.twig' %}

{% set breadcrumbs_enabled = false %}

{% block title %}
    Diskuse: {{ content.title }} | {{ type.name|default('Obsah') }}
{% endblock %}

{% block body %}
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="d-flex align-items-center gap-3 mt-4 flex-wrap">
                <div>
                    <h1 class="h4 mb-0">Diskuse: {{ content.title }}</h1>
                </div>
            </div>

            {% set perex = content.excerpt ?: (content.body|default('')|striptags|slice(0, 240)) %}
            {% if perex or thumbnail %}
                <div class="d-flex align-items-start gap-3 mt-3">
                    {% if thumbnail %}
                        <div class="article-thumb flex-shrink-0 d-flex align-items-center justify-content-center text-uppercase fw-bold" aria-hidden="true">
                            <img src="/{{ thumbnail.path }}/{{ thumbnail.webp_filename ?: thumbnail.filename }}" alt="{{ thumbnail.alt ?: content.title }}" loading="lazy" decoding="async">
                        </div>
                    {% endif %}
                    {% if perex %}
                        <p class="mb-0 text-muted">{{ perex }}</p>
                    {% endif %}
                </div>
            {% endif %}

            {% if comment_allowed %}
                <section class="card shadow-sm mt-3">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                            <h2 class="h5 mb-0">Diskuse ({{ comments|length }})</h2>
                            <a href="{{ content_url }}" class="btn btn-link text-decoration-none p-0">Zpět na článek</a>
                        </div>

                        <form method="post" action="/comments" class="mt-3" id="commentForm">
                            <input type="hidden" name="content_id" value="{{ content.id }}">
                            <input type="hidden" name="parent_id" value="">
                            <input type="hidden" name="reply_depth" value="">
                            <input type="hidden" name="mention_only" value="0">
                            <input type="hidden" name="_csrf" value="{{ csrf_token('comment_form') }}">

                            <div id="replyInfo" class="alert alert-secondary d-none py-2 px-3 mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="small"><span data-reply-label>Odpovídáte na</span> <strong id="replyTarget"></strong></div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="cancelReply">Zrušit</button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="comment_body" class="form-label">Komentář</label>
                                <textarea class="form-control" id="comment_body" name="body" rows="4" required {% if not commenting_enabled %}disabled{% endif %}></textarea>
                            </div>

                            {% if current_user %}
                                <div class="alert alert-light border">
                                    Přihlášen jako <strong>{{ current_user.nickname ?: current_user.email }}</strong>. Přezdívka se použije u komentáře.
                                </div>
                            {% elseif comment_settings.allow_anonymous %}
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="comment_author" class="form-label">Jméno</label>
                                        <input type="text" class="form-control" id="comment_author" name="author_name" value="" required {% if not commenting_enabled %}disabled{% endif %}>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="comment_email" class="form-label">E-mail</label>
                                        <input type="email" class="form-control" id="comment_email" name="author_email" value="" required {% if not commenting_enabled %}disabled{% endif %}>
                                    </div>
                                </div>
                            {% endif %}

                            {% if not commenting_enabled %}
                                <div class="alert alert-info mt-3">Komentáře jsou povoleny pouze pro přihlášené uživatele.</div>
                            {% endif %}

                            <div id="commentAlert" class="alert d-none mt-3" role="alert"></div>

                            <button type="submit" class="btn btn-primary mt-3" {% if not commenting_enabled %}disabled{% endif %}>Odeslat</button>
                        </form>

                        <hr class="my-4">

                        {% if comments %}
                            <div class="comment-thread" role="list">
                                {% for comment in comments %}
                                    {% set has_parent = comment.depth > 0 %}
                                    <article class="comment-item{% if has_parent %} has-parent{% endif %}{% if comment.depth == 0 %} is-root{% endif %}" id="comment-{{ comment.id }}" data-depth="{{ comment.depth }}" style="--comment-indent: {{ comment.depth }}" role="listitem">
                                        <div class="comment-card">
                                            <div class="comment-inner">
                                                <div class="comment-avatar">
                                                    <span class="avatar avatar-sm bg-primary-subtle text-primary fw-bold flex-shrink-0">
                                                        {% if comment.avatar.url %}
                                                            <img src="{{ comment.avatar.url }}" alt="Avatar {{ comment.author_name ?: 'Anonym' }}" class="rounded-circle" loading="lazy">
                                                        {% else %}
                                                            {{ comment.avatar.initials }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="comment-body">
                                                    <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
                                                        <div>
                                                            <div class="fw-semibold">
                                                                {% if comment.profile_url %}
                                                                    <a href="{{ comment.profile_url }}" class="text-decoration-none">{{ comment.author_name ?: 'Anonym' }}</a>
                                                                {% else %}
                                                                    {{ comment.author_name ?: 'Anonym' }}
                                                                {% endif %}
                                                            </div>
                                                            <div class="text-muted small">{{ comment.created_at|date('j. n. Y H:i') }}</div>
                                                        </div>
                                                        {% set can_thread_reply = comment_settings.allow_replies and comment_settings.max_depth > comment.depth and commenting_enabled %}
                                                        {% set can_mention = comment_settings.allow_replies and comment_settings.max_depth > 0 and comment_settings.max_depth <= comment.depth and commenting_enabled %}
                                                        {% if can_thread_reply or can_mention %}
                                                            <button
                                                                type="button"
                                                                class="btn btn-sm btn-outline-primary rounded-pill reply-button"
                                                                data-reply-id="{{ comment.id }}"
                                                                data-reply-author="{{ comment.author_name ?: 'Anonym' }}"
                                                                data-mention-only="{{ can_mention and not can_thread_reply ? '1' : '0' }}"
                                                                data-reply-depth="{{ comment.depth }}"
                                                            >
                                                                <i class="bi bi-reply me-1"></i> Reagovat
                                                                {% if can_mention and not can_thread_reply %}
                                                                    <span class="visually-hidden">(zmínka)</span>
                                                                {% endif %}
                                                            </button>
                                                        {% endif %}
                                                    </div>
                                                    <div class="mt-2 comment-text">{{ comment.body|nl2br }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </article>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted mb-0">Buďte první, kdo přidá komentář.</p>
                        {% endif %}
                    </div>
                </section>
            {% else %}
                <div class="alert alert-info mt-4">Diskuse u tohoto obsahu je uzavřena.</div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ parent() }}
    {% if comment_allowed %}
        <script>
            (function() {
                const form = document.getElementById('commentForm');
                if (!form) return;

                const parentField = form.querySelector('input[name="parent_id"]');
                const replyInfo = document.getElementById('replyInfo');
                const replyTarget = document.getElementById('replyTarget');
                const replyLabel = replyInfo ? replyInfo.querySelector('[data-reply-label]') : null;
                const cancelReply = document.getElementById('cancelReply');
                const mentionField = form.querySelector('input[name="mention_only"]');
                const replyDepthField = form.querySelector('input[name="reply_depth"]');

                const commentBody = document.getElementById('comment_body');
                const alertBox = document.getElementById('commentAlert');
                let isMentionOnly = false;
                let mentionPrefix = '';
                let currentReplyDepth = '';
                document.querySelectorAll('.reply-button').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        if (commentBody && mentionPrefix && commentBody.value.startsWith(mentionPrefix)) {
                            commentBody.value = commentBody.value.slice(mentionPrefix.length);
                        }

                        isMentionOnly = btn.dataset.mentionOnly === '1';
                        const replyAuthor = btn.dataset.replyAuthor || 'komentář';
                        parentField.value = isMentionOnly ? '' : btn.dataset.replyId;
                        if (mentionField) {
                            mentionField.value = isMentionOnly ? '1' : '0';
                        }

                        mentionPrefix = isMentionOnly && replyAuthor ? `@${replyAuthor} ` : '';
                        if (commentBody && mentionPrefix && !commentBody.value.startsWith(mentionPrefix)) {
                            const existingText = commentBody.value.trim();
                            commentBody.value = existingText ? `${mentionPrefix}${existingText}` : mentionPrefix;
                        }

                        if (replyInfo && replyTarget) {
                            replyTarget.textContent = replyAuthor;
                            if (replyLabel) {
                                replyLabel.textContent = isMentionOnly ? 'Zmiňujete' : 'Odpovídáte na';
                            }
                            replyInfo.classList.remove('d-none');
                        }
                        if (commentBody) {
                            commentBody.focus();
                        }
                    });
                });

                if (cancelReply) {
                    cancelReply.addEventListener('click', () => {
                        parentField.value = '';
                        if (mentionField) {
                            mentionField.value = '0';
                        }
                        if (commentBody && mentionPrefix && commentBody.value.startsWith(mentionPrefix)) {
                            commentBody.value = commentBody.value.slice(mentionPrefix.length);
                        }
                        mentionPrefix = '';
                        isMentionOnly = false;
                        if (replyLabel) {
                            replyLabel.textContent = 'Odpovídáte na';
                        }
                        if (replyTarget) {
                            replyTarget.textContent = '';
                        }
                        if (replyInfo) {
                            replyInfo.classList.add('d-none');
                        }
                    });
                }

                form.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    if (!commentBody || commentBody.value.trim() === '') {
                        if (alertBox) {
                            alertBox.textContent = 'Text komentáře je povinný.';
                            alertBox.className = 'alert alert-danger mt-3';
                            alertBox.classList.remove('d-none');
                        }
                        return;
                    }

                    const formData = new FormData(form);
                    formData.set('parent_id', parentField ? parentField.value : '');
                    formData.set('mention_only', mentionField ? mentionField.value : '0');
                    if (replyDepthField) {
                        formData.set('reply_depth', replyDepthField.value || '');
                    }

                    try {
                        const response = await fetch('/comments', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'Accept': 'application/json',
                            },
                        });

                        const data = await response.json();

                        if (alertBox) {
                            alertBox.textContent = data.message || 'Komentář byl odeslán.';
                            alertBox.className = 'alert mt-3 ' + (data.status === 'success' ? 'alert-success' : 'alert-danger');
                            alertBox.classList.remove('d-none');
                        }

                        if (data.status === 'success') {
                            form.reset();
                            if (replyInfo) {
                                replyInfo.classList.add('d-none');
                            }
                        }
                    } catch (error) {
                        if (alertBox) {
                            alertBox.textContent = 'Odeslání komentáře se nezdařilo. Zkuste to prosím znovu.';
                            alertBox.className = 'alert alert-danger mt-3';
                            alertBox.classList.remove('d-none');
                        }
                    }
                });
            })();
        </script>
    {% endif %}
{% endblock %}
