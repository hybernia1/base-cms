{% extends 'admin/layout.twig' %}

{% set current_menu = 'media' %}
{% import 'admin/partials/components.twig' as ui %}

{% block title %}Média | Administrace{% endblock %}

{% block body %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Média</h1>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">Nahrát soubor</div>
        <div class="card-body">
            <form method="post" action="/admin/media/upload" enctype="multipart/form-data" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label" for="file">Soubor</label>
                    <input type="file" name="file" id="file" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="alt">Alt text / popisek</label>
                    <input type="text" name="alt" id="alt" class="form-control" placeholder="Volitelný popis">
                </div>
                <div class="col-md-4">
                    {{ ui.button('upload', null, { type: 'submit', class: 'w-100 w-md-auto' }) }}
                </div>
            </form>
        </div>
    </div>
    <div class="ajax-block" data-ajax-container data-endpoint="/admin/media" data-current-url="{{ pagination.current_url }}">
        {% include 'admin/media/_list.twig' with { items: items, pagination: pagination } only %}
    </div>

    <div class="modal fade" id="mediaDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-role="media-title">Detail média</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3" id="mediaDetailForm" data-media-id="">
                        <div class="col-md-6 text-center">
                            <div class="ratio ratio-4x3 border rounded bg-light d-flex align-items-center justify-content-center">
                                <img src="" alt="" class="img-fluid" data-role="media-preview" style="max-height: 320px;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="mediaAltInput" class="form-label">Alt text / popis</label>
                                <input type="text" class="form-control" id="mediaAltInput" placeholder="Popisek obrázku">
                            </div>
                            <dl class="row small mb-3">
                                <dt class="col-4 text-muted">Název</dt>
                                <dd class="col-8" data-role="media-name">&nbsp;</dd>
                                <dt class="col-4 text-muted">MIME</dt>
                                <dd class="col-8" data-role="media-mime">&nbsp;</dd>
                                <dt class="col-4 text-muted">Velikost</dt>
                                <dd class="col-8" data-role="media-size">&nbsp;</dd>
                                <dt class="col-4 text-muted">Vytvořeno</dt>
                                <dd class="col-8" data-role="media-created">&nbsp;</dd>
                            </dl>
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <span class="badge bg-secondary" data-role="media-webp">Bez WebP</span>
                                <a href="#" target="_blank" rel="noopener" class="small" data-role="media-open">Otevřít náhled</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-role="media-convert">Vytvořit WebP</button>
                    <button type="button" class="btn btn-primary" data-role="media-save">Uložit změny</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    const mediaModalEl = document.getElementById('mediaDetailModal');
    const mediaModal = mediaModalEl ? new bootstrap.Modal(mediaModalEl) : null;
    const mediaForm = document.getElementById('mediaDetailForm');
    const mediaPreview = mediaModalEl?.querySelector('[data-role="media-preview"]');
    const mediaName = mediaModalEl?.querySelector('[data-role="media-name"]');
    const mediaMime = mediaModalEl?.querySelector('[data-role="media-mime"]');
    const mediaSize = mediaModalEl?.querySelector('[data-role="media-size"]');
    const mediaCreated = mediaModalEl?.querySelector('[data-role="media-created"]');
    const mediaAltInput = document.getElementById('mediaAltInput');
    const mediaWebpBadge = mediaModalEl?.querySelector('[data-role="media-webp"]');
    const mediaOpenLink = mediaModalEl?.querySelector('[data-role="media-open"]');
    const convertBtn = mediaModalEl?.querySelector('[data-role="media-convert"]');
    const saveBtn = mediaModalEl?.querySelector('[data-role="media-save"]');

    const humanSize = (bytes) => {
        if (Number.isNaN(bytes)) return '';
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} kB`;
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    };

    const updateCardBadge = (card, hasWebp, previewUrl) => {
        const badge = card.querySelector('.badge-webp');
        if (badge) {
            badge.textContent = hasWebp ? 'WebP' : 'Bez WebP';
            badge.className = hasWebp
                ? 'badge bg-success position-absolute top-0 end-0 m-2 badge-webp'
                : 'badge bg-warning text-dark position-absolute top-0 end-0 m-2 badge-webp';
        }

        const img = card.querySelector('img');
        if (img && previewUrl) {
            img.src = previewUrl;
        }
        card.dataset.webpFilename = hasWebp ? (card.dataset.webpFilename || '1') : '';
        if (previewUrl) {
            card.dataset.previewUrl = previewUrl;
        }
    };

    const fillMediaModal = (card) => {
        if (!mediaForm || !mediaModal) return;
        const previewUrl = card.dataset.previewUrl || '';
        mediaForm.dataset.mediaId = card.dataset.mediaId || '';
        if (mediaPreview) {
            mediaPreview.src = previewUrl;
            mediaPreview.alt = card.dataset.alt || '';
        }
        if (mediaAltInput) mediaAltInput.value = card.dataset.alt || '';
        if (mediaName) mediaName.textContent = card.dataset.name || '';
        if (mediaMime) mediaMime.textContent = card.dataset.mime || '';
        if (mediaSize) mediaSize.textContent = humanSize(Number(card.dataset.size));
        if (mediaCreated) mediaCreated.textContent = card.dataset.created || '';
        if (mediaWebpBadge) {
            const hasWebp = Boolean(card.dataset.webpFilename);
            mediaWebpBadge.textContent = hasWebp ? 'WebP varianta dostupná' : 'Bez WebP';
            mediaWebpBadge.className = hasWebp ? 'badge bg-success' : 'badge bg-secondary';
        }
        if (mediaOpenLink) {
            mediaOpenLink.href = previewUrl || '#';
            mediaOpenLink.style.display = previewUrl ? '' : 'none';
        }

        if (convertBtn) {
            convertBtn.disabled = Boolean(card.dataset.webpFilename);
        }

        mediaModal.show();
    };

const saveMediaDetails = async (forceWebp = false) => {
    if (!mediaForm) return;

    const id = mediaForm.dataset.mediaId;
    if (!id) return;

    const formData = new FormData();
    const altFromInput = mediaAltInput?.value || '';

    formData.append('alt', altFromInput);
    if (forceWebp) {
        formData.append('convert_webp', '1');
    }

    try {
        const response = await fetch(`/admin/media/${id}/update`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
            },
        });

        const result = await response.json();
        if (!response.ok || result.error || result.success === false) {
            throw new Error(result.error || result.message || 'Uložení se nezdařilo.');
        }

        // VŠECHNA DATA JSOU V result.data
        const data = result.data || {};

        // Najdeme kartu
        const card = document.querySelector(`.media-card[data-media-id="${id}"]`);

        // ALT – primárně z API, jinak z inputu
        const newAlt = (typeof data.alt !== 'undefined' && data.alt !== null)
            ? data.alt
            : altFromInput;

        // URL náhledu – ideálně WebP, které server poslal
        const existingPreviewFromCard = card?.dataset.previewUrl || '';
        const existingPreviewFromImg  = card?.querySelector('img')?.src || mediaPreview?.src || '';
        const previewUrl = data.preview_url || existingPreviewFromCard || existingPreviewFromImg || '';

        const hasWebp = Boolean(data.webp_filename);

        if (card) {
            // dataset z API
            if (typeof data.alt !== 'undefined') {
                card.dataset.alt = data.alt;
            } else {
                card.dataset.alt = newAlt;
            }

            if (data.preview_url) {
                card.dataset.previewUrl = data.preview_url;
            }

            if (data.webp_filename) {
                card.dataset.webpFilename = data.webp_filename;
            }

            if (data.filename) {
                card.dataset.name = data.filename;
            }

            const cardImg = card.querySelector('img');
            if (cardImg) {
                if (previewUrl) cardImg.src = previewUrl;
                cardImg.alt = newAlt;
            }

            updateCardBadge(card, hasWebp, previewUrl);
        }

        // MODÁL
        if (mediaPreview && previewUrl) {
            mediaPreview.src = previewUrl;
        }
        if (mediaPreview) {
            mediaPreview.alt = newAlt;
        }
        if (mediaAltInput) {
            mediaAltInput.value = newAlt;
        }

        if (mediaWebpBadge) {
            mediaWebpBadge.textContent = hasWebp ? 'WebP varianta dostupná' : 'Bez WebP';
            mediaWebpBadge.className = hasWebp ? 'badge bg-success' : 'badge bg-secondary';
        }

        if (mediaOpenLink) {
            mediaOpenLink.href = previewUrl || '#';
            mediaOpenLink.style.display = previewUrl ? '' : 'none';
        }

        if (convertBtn) {
            convertBtn.disabled = hasWebp;
        }

        adminNotify.show({
            title: 'Hotovo',
            message: result.message || 'Změny byly uloženy.',
            variant: 'success',
        });
    } catch (error) {
        adminNotify.show({
            title: 'Chyba',
            message: error.message || 'Uložení se nezdařilo.',
            variant: 'danger',
            autohide: false,
        });
    }
};


    document.querySelectorAll('.media-card').forEach((card) => {
        card.addEventListener('click', (event) => {
            if (event.target.closest('.btn-group') || event.target.closest('form')) {
                return;
            }

            fillMediaModal(card);
        });
        card.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                fillMediaModal(card);
            }
        });
    });

    if (convertBtn) {
        convertBtn.addEventListener('click', () => saveMediaDetails(true));
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', () => saveMediaDetails(false));
    }
</script>
{% endblock %}
